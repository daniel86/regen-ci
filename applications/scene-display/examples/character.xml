<?xml version="1.0" encoding="UTF-8" ?>

<node>
    <constant name="far-plane" value="100.0"/>
    <constant name="close-range" value="40.0"/>
    <constant name="mid-range" value="100.0"/>
    <constant name="map-y" value="-2.0"/>

    <include xml-file="scene-display/examples/templates/default.xml"/>

    <node id="configuration"
            date="01-09-2014 06:00:00"
            time-scale="60.0">
        <controller type="user-kinematic"
                mode="third-person" camera="main-camera"
                animation-asset="dwarf-asset"
                step-height="0.9"
                max-slope="0.8"
                collision-radius="0.9"
                collision-height="3.9"
                gravity-force="50.0"
                jump-velocity="26.0"
                speed="0.4"
                mesh="dwarf-mesh"
                mesh-index="1"
                mesh-distance="20.0"
                mesh-horizontal-orientation="3.14159265359"
                vertical-orientation="0.16"
                transform="dwarf-tf"
                eye-offset="0.0,2.75,0.0">
            <key-mapping key="Space" camera="jump" motion="jump" />
            <key-mapping key="C" camera="crouch" motion="crouch" toggle="1" />
            <key-mapping key="W" camera="move_forward" motion="walk"/>
            <key-mapping key="A" camera="move_left" motion="walk"/>
            <key-mapping key="D" camera="move_right" motion="walk"/>
            <key-mapping key="S" camera="move_backward" motion="walk" backwards="1"/>
            <mouse-mapping button="1" motion="attack"/>
            <mouse-mapping button="2" motion="block"/>
        </controller>
    </node>

    <!-- FBOs -->
    <fbo id="g-buffer"
         size-mode="rel" size="1.0,1.0"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="tmp"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <texture id="emission" pixel-components="3"/>
        <depth id="depth" pixel-size="24"/>
    </fbo>
    <fbo id="particle-fbo" size-mode="rel" size="0.25, 0.25"
         pixel-type="FLOAT" pixel-size="24">
        <texture id="density" pixel-components="1"/>
        <texture id="color" pixel-components="4"/>
    </fbo>
    <fbo id="room-light-shadow0"
         target="TEXTURE_2D_ARRAY"
         size-mode="abs" size="2048,2048,1">
        <depth pixel-size="24" pixel-type="FLOAT"
               wrapping="CLAMP_TO_EDGE"
               min-filter="NEAREST"
               mag-filter="NEAREST"
               compare-mode="COMPARE_R_TO_TEXTURE"
               compare-function="LEQUAL"
               sampler-type="sampler2DArrayShadow"/>
    </fbo>
    <fbo id="collision-fbo" size-mode="abs" size="256,256"
         pixel-type="UNSIGNED_BYTE" pixel-size="8">
        <texture id="collision" pixel-components="1" />
        <texture id="static-collision" pixel-components="1"/>
    </fbo>
    <!-- Textures -->
    <texture id="emission-map-bloom" type="bloom" num-mips="4" input-fbo="g-buffer"/>
    <texture id="ground-color" file="res/textures/materials/grass/0/ground.png"/>
    <texture id="glow-map" file="res/textures/glow-map.tga" wrapping="CLAMP_TO_EDGE"/>
    <texture id="sand" file="res/textures/materials/sand.jpg"/>
    <texture id="wind-flowmap" file="res/textures/wind/flowmap0.png" wrapping="REPEAT"/>
    <texture id="wind-noise" type="noise" preset="cloud"
            size="128.0,128.0,1.0" swizzle-g="RED" swizzle-b="RED"/>
    <texture id="particle-splat" file="res/textures/splats/flare.jpg"/>
    <!--
    <texture id="particle-color-ramp" ramp="inline" format="RGB">
        <texel v="255, 255, 20"/>
        <texel v="250, 60, 20"/>
        <texel v="230, 40, 20"/>
        <texel v="160, 20, 8"/>
        <texel v="0, 0, 0"/>
        <texel v="0, 0, 0"/>
    </texture>
    -->
    <!-- Spatial Index -->
    <index id="main-index" type="quadtree"
            min-node-size="2.0"
            max-objects-per-node="4"/>
    <!-- Cameras -->
    <camera id="main-camera"
            fov="45.0" near="0.1" far="{{far-plane}}"
            position="25.0,2.5,2.0"
            direction="1.0,0.0,-1.0">
        <culling index="main-index" />
    </camera>
    <camera id="room-light-camera0"
            light="room-light0"
            camera="main-camera"
            camera-type="paraboloid"
            dual-paraboloid="0"
            update-frequency="NEVER">
    </camera>
    <!-- Orthogonal top-down camera used for collision map generation -->
    <camera id="collision-camera" type="orthogonal"
            width="90.0" height="90.0" far="2.0"
            position="0.0, 0.0, 0.0"
            direction="0.0,-1.0,0.0"
            up="0.0,0.0,1.0"
            update-frequency="NEVER">
    </camera>
    <!--
<camera id="room-light-camera0"
    culling-index="main-index"
    light="room-light0"
    camera="main-camera"
    camera-type="cube"
    hide-faces="top" />
    -->
    <!-- Lights -->
    <light id="room-light0"
           type="POINT"
           position="-5.0,24.0,0.0"
           radius="30.0,54.0"
           direction="0.0,-1.0,0.0"
           diffuse="0.8,0.9,0.835"
           ambient="0.6,0.6,0.6"
           update-frequency="NEVER"/>
    <asset id="dwarf-asset"
           type="asset"
           file="res/models/psionic/dwarf/x/dwarf.x"
           texture-path="res/models/psionic/dwarf/x"
           use-animation="1"
           animation-force-states="1"
           animation-post-state="LINEAR"
           animation-pre-state="LINEAR"
           animation-tps="20.0">
        <bone-animation>
            <body-part type="head" start-node="head"/>
            <body-part type="leg" start-node="lhip"/>
            <body-part type="leg" start-node="rhip"/>
            <body-part type="arm" start-node="lsholda"/>
            <body-part type="arm" start-node="rsholda"/>
            <body-part type="torso" start-node="spine2"/>
            <range motion="attack" name="attack1" range="111.0,125.0" />
            <range motion="attack" name="attack2" range="127.0,141.0" />
            <range motion="attack" name="attack3" range="143.0,159.0" />
            <range motion="attack" name="attack4" range="161.0,179.0" />
            <range motion="attack" name="attack5" range="181.0,191.0" />
            <range motion="block" name="block" range="193.0,209.0" />
            <range motion="walk" name="walk" range="1.0,13.0" />
            <range motion="run" name="run" range="15.0,25.0" />
            <!--
            <range motion="jump" name="jump" range="27.0,39.0" />
            -->
            <range motion="jump" name="jump-spot" range="41.0,53.0" />
            <range name="crouch-down" range="55.0,58.0" />
            <range name="crouch-loop" range="59.0,68.0" />
            <range name="get-up" range="69.0,73.0" />
            <range motion="die" name="dieFwd" range="211.0,226.0" />
            <range motion="die" name="dieBack" range="229.0,250.0" />
            <range motion="agree" name="yes" range="252.0,271.0" />
            <range motion="disagree" name="no" range="273.0,289.0" />
            <range motion="idle" name="idle1" range="291.0,324.0" />
            <range motion="idle" name="idle2" range="326.0,359.0" />
            <!--
            <range name="battleIdle1" range="74.0,87.0"/>
            <range name="battleIdle2" range="89.0,109.0"/>
            -->
            <!-- Define some composite motions. -->
            <clip motion="crouch" range="crouch-loop" begin="crouch-down" end="get-up" />
            <clip motion="pray" range="crouch-loop" begin="crouch-down" end="get-up" />
            <clip motion="revive" range="get-up" />
        </bone-animation>
    </asset>
    <!-- UBOs -->
    <block type="ubo" id="SceneUBO" update-frequency="NEVER">
        <uniform name="surfaceHeight" type="float" value="-1.0"/>
        <uniform name="planeSize" type="vec2" value="{{map-size}}, {{map-size}}"/>
        <uniform name="wind" type="vec2" value="0.6, 0.6"/>
        <uniform name="windFlowScale" type="float" value="150.0"/>
        <uniform name="windFlowTime" type="float" value="0.2"/>
        <uniform name="windStrength" type="float" value="1.0"/>
    </block>
    <!-- Sky -->
    <sky id="sky" camera="main-camera" update-interval="200.0" surface-height="-2.0">
        <star-map texture="res/sky/milkyway.png" scattering="0.8" delta-magnitude="0.05" lod="0" />
        <stars catalog="res/sky/bright-stars.bin" scale="1.4"
            scattering="1.0" scintillation="0.2" apparent-magnitude="6.0"
            glare-intensity="0.04" glare-scale="0.2"
            color="0.66,0.78,1.0" color-ratio="0.66"/>
        <moon texture="res/sky/moon.png" scale="0.04" scattering="4.0"
            sun-shine-color="0.923,0.786,0.636" sun-shine-intensity="128.0"
            earth-shine-color="0.88,0.96,1.0" earth-shine-intensity="8.0" />
        <atmosphere preset="earth" size="256" lod="0">
            <input type="float" name="cirrus" value="0.8" />
            <input type="float" name="cumulus" value="0.6" />
            <input type="float" name="dithering" value="0.2" />
            <input type="float" name="ditheringScale" value="100.0" />
            <input type="float" name="cloudTimeFactor" value="0.3" />
        </atmosphere>
    </sky>
    <node id="Sky">
        <sky id="sky"/>
    </node>

    <!--**************************-->
    <!--******* Character ********-->
    <!--**************************-->

    <mesh id="dwarf-mesh" type="asset" asset="dwarf-asset" asset-indices="*" asset-animation="1">
        <transform id="dwarf-tf">
            <rotate value="1.5707963,0.0,0.0"/>
            <translate value="3.0,0.1,-32.0"/>
        </transform>
    </mesh>

    <!--**************************-->
    <!--********* Ground *********-->
    <!--**************************-->

    <mesh id="ground-mesh" type="rectangle" use-normal="1" use-texco="1" use-tangent="1" center="1" lod="4"
          rotation="0.0,0.0,3.1415"
          scaling="400.0,20.0,400.0"
          texco-scaling="10.0,10.0"
          update-frequency="NEVER">
        <transform id="ground-tf" update-frequency="NEVER">
            <translate value="0.0,-2.0,0.0"/>
        </transform>
        <material preset="iron" variant="0"/>
        <shape id="ground-physics" physics="1" shape="triangle-mesh" mass="0.0"
               mesh-id="ground-mesh" transform-id="ground-tf"/>
    </mesh>

    <!--**************************-->
    <!--********* Trees *********-->
    <!--**************************-->

    <mesh id="tree-mesh" type="proctree"
            use-silhouette="1"
            tile-counts="4,2,2,2"
            alpha-cut="0.1"
            coverage-threshold="0.01"
            silhouette-padding="1"
            preset="fir">
        <shader mesh-index="0" key="regen.objects.mesh"/>
        <shader mesh-index="1" key="regen.objects.mesh">
            <define key="POS_WORLD_TRANSFER_KEY" value="regen.objects.sky.wind.wavingBaseTransfer"/>
        </shader>
        <transform id="tree-tf">
            <scale value="4.0, 4.0, 4.0"/>
            <rotate value="1.5707963,0.0,0.0"/>
            <translate value="8.0,-2.0, -8.0"/>
        </transform>
        <shape id="tree-shape" index="1" cull="1" type="aabb" mesh-id="tree-mesh" transform-id="tree-tf">
            <has-part mesh-id="tree-mesh" mesh-index="1"/>
        </shape>
        <shape id="tree-mesh-physics" physics="1" shape="box" mass="0.0" size="0.6, 6.0, 0.6"
               mesh-id="tree-mesh" transform-id="tree-tf"/>
    </mesh>

    <mesh id="tree-pot" type="torus"
          lod-levels="3, 2, 1"
          use-normal="1" use-tangent="1" center="1"
          scaling="3.0, 3.0, 3.0" texco-scaling="3.0, 1.0"
          ring-radius="1.0" tube-radius="0.2"
          update-frequency="NEVER">
        <transform id="tree-pot-tf" update-frequency="NEVER">
            <translate value="8.0, -1.4, -8.0"/>
        </transform>
        <shape id="tree-pot-shape" index="1" cull="1" type="aabb"
               mesh-id="tree-pot" transform-id="tree-pot-tf">
            <has-part mesh-id="tree-disc"/>
        </shape>
        <shape id="tree-pot-physics" physics="1" shape="cylinder" mass="0.0" size="7.2,1.2,7.2"
               mesh-id="tree-pot" transform-id="tree-pot-tf"/>
        <material preset="stone" color-blend-mode="MUL" emission="0.04, 0.04, 0.04"/>
    </mesh>

    <mesh id="tree-disc" type="disc"
          lod-levels="3, 2, 1"
          use-normal="1" center="1" scaling="3.0, 3.0, 3.0"
          texco-scaling="0.1, 0.1" disc-radius="1.0"
          update-frequency="NEVER">
        <transform id="tree-disc-tf" update-frequency="NEVER">
            <translate value="8.0, -1.0, -8.0"/>
        </transform>
    </mesh>

    <node id="Trees">
        <node id="tree1">
            <node id="tree1-trunk">
                <input name="matEmission" type="vec3" value="0.01,0.01,0.01"/>
                <mesh id="tree-mesh" mesh-index="0"/>
            </node>
            <node id="tree1-twig">
                <alpha discard-threshold="0.25" />
                <input name="matEmission" type="vec3" value="0.0,0.02,0.0"/>
                <define key="POS_WORLD_TRANSFER_KEY" value="regen.objects.sky.wind.wavingBaseTransfer"/>
                <texture name="windFlow" id="wind-flowmap"/>
                <input name="stiffness" type="float" value="0.5"/>
                <!-- draw the mesh -->
                <mesh id="tree-mesh" mesh-index="1" update-visibility="0"/>
            </node>
        </node>
        <node id="tree1-pot">
            <node id="tree1-pot">
                <mesh id="tree-pot" shader="regen.objects.mesh"/>
            </node>
            <node id="tree1-pot-disc">
                <texture id="sand" map-to="color" blend-mode="SRC"/>
                <material specular="0.0, 0.0, 0.0" update-frequency="NEVER"/>
                <mesh id="tree-disc" shader="regen.objects.mesh" update-visibility="0" />
            </node>
        </node>
    </node>

    <!--**************************-->
    <!--********* Other Stuff *********-->
    <!--**************************-->

    <mesh id="stone0" type="sphere" use-normal="1" use-texco="1" use-tangent="1"
          lod-levels="4, 3, 2"
          lod-thresholds="20.0, 50.0, 0.0"
          scaling="1.5,3.0,3.0"
          num-instances="20"
          update-frequency="NEVER">
        <transform id="stone0-tf" num-instances="20" is-instanced="1">
            <rotate value="0.0, 1.57079632, 0.0"/>
            <translate value="0.0, -0.6, 0.0"/>
            <set mode="circle" target="translate" radius="42.0" variance="0.8"
                 dir-x="1.0, 0.0, 0.0" dir-z="0.0, 0.0, 1.0"/>
        </transform>
        <material preset="stone" variant="0" max-offset="0.2" update-frequency="NEVER"/>
        <shape id="stone0-shape" index="1" cull="1" type="sphere"
               mesh-id="stone0" transform-id="stone0-tf" radius="1.6"/>
        <shape id="stone0-physics" physics="1"
               mesh-id="stone0" transform-id="stone0-tf" shape="capsule" radius="1.0" height="0.4" mass="2.0"/>
    </mesh>

    <node id="Garden-Items">
        <node import="Trees"/>
        <node id="Stone0">
            <mesh id="stone0" shader="regen.objects.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--********* Stairs *********-->
    <!--**************************-->

    <mesh id="stairs0-mesh" type="box" lod="1" use-normal="1" use-tangent="1" center="1"
          scaling="8.0,0.4,4.0" texco-scaling="0.5, 0.5"
          update-frequency="NEVER">
        <transform id="stairs0-tf">
            <translate value="16.0,-1.47,16.0"/>
        </transform>
        <shape id="stairs0-shape" index="1" cull="1" type="aabb"
               mesh-id="stairs0-mesh" transform-id="stairs0-tf"/>
        <shape id="stairs0-physics" physics="1"
               mesh-id="stairs0-mesh" transform-id="stairs0-tf" shape="box" mass="0.0" size="16.0,0.8,8.0"/>
    </mesh>

    <mesh id="stairs1-mesh" type="box" lod="1" use-normal="1" use-tangent="1" center="1"
          scaling="6.0,0.4,4.0" texco-scaling="0.5, 0.5"
          update-frequency="NEVER">
        <transform id="stairs1-tf">
            <translate value="16.0,-0.67,16.0"/>
        </transform>
        <shape id="stairs1-shape" index="1" cull="1" type="aabb"
               mesh-id="stairs1-mesh" transform-id="stairs1-tf"/>
        <shape id="stairs1-physics" physics="1"
               mesh-id="stairs1-mesh" transform-id="stairs1-tf" shape="box" mass="0.0" size="12.0,0.8,8.0"/>
    </mesh>

    <mesh id="stairs2-mesh" type="box" lod="1" use-normal="1" use-tangent="1" center="1"
          scaling="4.0,0.4,4.0" texco-scaling="0.5, 0.5"
          update-frequency="NEVER">
        <transform id="stairs2-tf">
            <translate value="16.0,0.13,16.0"/>
        </transform>
        <shape id="stairs2-shape" index="1" cull="1" type="aabb"
               mesh-id="stairs2-mesh" transform-id="stairs2-tf"/>
        <shape id="stairs2-physics" physics="1"
               mesh-id="stairs2-mesh" transform-id="stairs2-tf" shape="box" mass="0.0" size="8.0,0.8,8.0"/>
    </mesh>

    <node id="Stairs">
        <material preset="steel" variant="0" update-frequency="NEVER"/>
        <!-- <material preset="stone" height-map-mode="parallax_occlusion" max-offset="0.2"/> -->
        <node id="stairs0">
            <mesh id="stairs0-mesh" shader="regen.objects.mesh"/>
        </node>
        <node id="stairs1">
            <mesh id="stairs1-mesh" shader="regen.objects.mesh"/>
        </node>
        <node id="stairs2">
            <mesh id="stairs2-mesh" shader="regen.objects.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--******** Platforms *******-->
    <!--**************************-->

    <mesh id="platform0-mesh" type="box" lod="1" use-normal="1" use-tangent="1" center="1"
          scaling="4.0,0.4,4.0" texco-scaling="0.5,0.5"
          update-frequency="NEVER">
        <transform id="platform0-tf">
            <translate value="16.0,3.0,-16.0"/>
            <animation type="key-frames" mesh-id="platform0-mesh" dt="2.5">
                <key-frame position="16.0,3.0,8.0"/>
                <key-frame position="16.0,3.0,-16.0"/>
            </animation>
        </transform>
        <shape id="platform0-shape" index="1" cull="1" type="aabb"
               mesh-id="platform0-mesh" transform-id="platform0-tf"/>
        <shape id="platform0-physics" physics="1"
               mesh-id="platform0-mesh" transform-id="platform0-tf"
               shape="box" mass="0.0" gravity="0.0, 0.0, 0.0" friction="20.0"
               size="8.0,0.8,8.0"/>
    </mesh>

    <mesh id="platform1-mesh" type="box" lod="1" use-normal="1" use-tangent="1" center="1"
          scaling="4.0,0.4,4.0" texco-scaling="0.5,0.5"
          update-frequency="NEVER">
        <transform id="platform1-tf">
            <translate value="8.0,7.0,-16.0"/>
            <animation type="key-frames" mesh-id="platform1-mesh" dt="2.5">
                <key-frame position="-20.0,7.0,-16.0"/>
                <key-frame position="8.0,7.0,-16.0"/>
            </animation>
        </transform>
        <shape id="platform1-shape" index="1" cull="1" type="aabb"
               mesh-id="platform1-mesh" transform-id="platform1-tf"/>
        <shape id="platform1-physics" physics="1"
               mesh-id="platform1-mesh" transform-id="platform1-tf"
               shape="box" mass="0.0" gravity="0.0, 0.0, 0.0" friction="20.0"
               size="8.0,0.8,8.0"/>
    </mesh>

    <node id="Platforms">
        <material preset="iron" variant="0" emission="0.015,0.017,0.017" update-frequency="NEVER"/>
        <node id="platform0">
            <mesh id="platform0-mesh" shader="regen.objects.mesh"/>
        </node>
        <node id="platform1">
            <mesh id="platform1-mesh" shader="regen.objects.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--**************************-->

    <mesh id="pedestal-mesh" type="box"
          lod-levels="3, 2, 1"
          use-normal="1" use-tangent="1" center="1"
          scaling="3.5,5.0,3.5" texco-scaling="0.25, 0.25"
          update-frequency="NEVER">
        <transform id="pedestal-tf">
            <rotate value="1.57079632,0.0,0.0"/>
            <translate value="-16.0, 3.0, -3.0"/>
        </transform>
        <shape id="pedestal-shape" index="1" cull="1" type="aabb"
               mesh-id="pedestal-mesh" transform-id="pedestal-tf"/>
        <shape id="pedestal-physics" physics="1"
               mesh-id="pedestal-mesh" transform-id="pedestal-tf"
               shape="box" size="7.0, 10.0, 7.0" mass="0.0"/>
        <material preset="wood" variant="1" color-blend-mode="mul"
                  diffuse="0.64, 0.41, 0.27" update-frequency="NEVER"/>
    </mesh>

    <mesh id="slope-mesh" type="box" use-normal="1" use-texco="1" use-tangent="1" center="1"
        lod="1" rotation="0.0,0.0,0.0" scaling="3.5,0.04,9.0" texco-scaling="0.25, 0.25"
        update-frequency="NEVER">
        <transform id="slope-tf">
            <rotate value="0,0, -0.6, 0.0"/>
            <translate value="-16.0, 3.0, 7.9"/>
        </transform>
        <shape id="slope-shape" index="1" cull="1" type="obb"
               mesh-id="slope-mesh" transform-id="slope-tf"/>
        <shape id="slope-physics" physics="1"
               mesh-id="slope-mesh" transform-id="slope-tf" shape="box" size="7,0.08,18" mass="0.0"/>
        <material preset="wood" variant="0" color-blend-mode="mul" diffuse="0.35, 0.35, 0.28"
                update-frequency="NEVER"/>
    </mesh>

    <node id="Pedestal">
        <node id="pedestal">
            <mesh id="pedestal-mesh" shader="regen.objects.mesh"/>
        </node>
        <node id="statue-slope">
            <mesh id="slope-mesh" shader="regen.objects.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--***** Particles etc. *****-->
    <!--**************************-->

    <block type="ubo" id="ParticlesUBO" update-frequency="NEVER">
        <uniform type="vec3" name="gravity" value="0.0,9.81,0.0"/>
        <uniform type="float" name="dampingFactor" value="1.0"/>
        <uniform type="vec3" name="emitterPosition" value="0.0, -0.5, 0.0"/>
        <uniform type="float" name="emitterSize" value="9.0"/>
        <uniform type="vec2" name="velocityFactorMinMax" value="5.0, 10.0"/>
        <uniform type="float" name="emitterOpening" value="0.5"/>
        <uniform type="float" name="lifetimeDefault" value="0.8"/>
        <uniform type="float" name="lifetimeVariance" value="0.5"/>
    </block>

    <node id="Particle-Config">
        <define key="PARTICLE_EMITTER_MODE" value="IN"/>
        <define key="PARTICLE_EMITTER_SHAPE" value="DISC"/>
        <define key="OPACITY_WEIGHTED_COLOR" value="TRUE"/>
        <input name="Particles" ubo="ParticlesUBO"/>
        <input name="Scene" ubo="SceneUBO"/>
        <texture name="windFlow" id="wind-flowmap"/>
    </node>

    <mesh id="test-particles1" type="particles" num-vertices="800" max-emits="10" animation-state="Particle-Config">
        <input type="vec3" name="pos" layout="std430" is-attribute="1"/>
        <input type="vec3" name="velocity" layout="std430" is-attribute="1"/>
        <input type="float" name="mass" layout="std430" is-attribute="1" default="1.4" variance="0.4"/>
        <input type="float" name="size" layout="std430" is-attribute="1" default="0.1" variance="0.05" advance-mode="ADD"
               advance-constant="2.0"/>
        <transform id="platform1-tf"/>
    </mesh>

    <mesh id="test-particles0" type="particles" num-vertices="800" max-emits="10" animation-state="Particle-Config">
        <input type="vec3" name="pos" layout="std430" is-attribute="1"/>
        <input type="vec3" name="velocity" layout="std430" is-attribute="1"/>
        <input type="float" name="mass" layout="std430" is-attribute="1" default="1.4" variance="0.4"/>
        <input type="float" name="size" layout="std430" is-attribute="1" default="0.1" variance="0.05" advance-mode="ADD"
               advance-constant="2.0"/>
        <transform id="platform0-tf"/>
    </mesh>

    <node id="Particle-Update-FBO">
        <define key="USE_NEAR_CAMERA_SOFT_PARTICLES" value="FALSE"/>
        <depth test="0" write="0"/>

        <node id="Particle-Density">
            <fbo id="particle-fbo" clear-buffers="0" draw-buffers="0"/>
            <blend mode="add"/>
            <texture name="depthTexture" fbo="g-buffer" attachment="depth"/>
            <!--
            <texture name="splatTexture" id="particle-splat" map-to="ALPHA" blend-mode="MUL"/>
            -->
            <texture name="splatTexture" id="particle-splat" map-to="ALPHA" blend-mode="MUL" texco-transfer="NOISE"/>
            <input type="float" name="uvNoiseScale" value="0.5"/>
            <input type="float" name="softParticleScale" value="30.0"/>
            <input type="float" name="lifetimeSmoothstep" value="1.0"/>
            <!-- Apply fogging based on distance. -->
            <input type="float" name="fogDensity" value="1.0"/>
            <input type="vec2" name="fogDistance" value="50.0,{{far-plane}}" min="0.0" max="{{far-plane}}"/>
            <input type="vec3" name="fogColor" value="0.2,0.33,0.3" schema="color"/>
            <input type="vec2" name="farDistance" value="75.0,{{far-plane}}"/>
            <node id="Particle-Density0">
                <mesh id="test-particles0" shader="regen.objects.particles.sprite.density"/>
            </node>
            <node id="Particle-Density1">
                <mesh id="test-particles1" shader="regen.objects.particles.sprite.density"/>
            </node>
        </node>

        <node id="Particle-Color">
            <define key="DISCARD_DENSITY_THRESHOLD" value="0.01"/>
            <fbo id="particle-fbo" clear-buffers="1" draw-buffers="1"/>
            <blend mode="alpha"/>
            <texture name="densityTexture" fbo="particle-fbo" attachment="0"/>
            <!--
            <texture name="colorRamp" id="particle-color-ramp" blend-mode="MUL"/>
            -->
            <texture name="windFlow" id="wind-flowmap"/>
            <input type="float" name="gamma" value="0.53"/>
            <input type="float" name="exposure" value="0.62"/>
            <input type="float" name="brightness" value="0.66"/>
            <input type="vec4" name="color" value="0.53, 0.53, 0.78, 0.8"/>
            <fullscreen-pass shader="regen.objects.particles.sprite.densityColor"/>
        </node>
        <view id="Particle-Density">
            <blit src-fbo="particle-fbo" src-attachment="0" dst-fbo="SCREEN"/>
        </view>
        <view id="Particle-Color">
            <blit src-fbo="particle-fbo" src-attachment="1" dst-fbo="SCREEN"/>
        </view>

        <!-- Finally, create a blurred version. -->
        <node id="Particle-Blur">
            <input type="int" name="numBlurPixels" value="9"/>
            <input type="float" name="blurSigma" value="2.3"/>
            <filter-sequence id="particle-color" fbo="particle-fbo" attachment="1">
                <filter shader="regen.passes.blur.horizontal"/>
                <filter shader="regen.passes.blur.vertical"/>
            </filter-sequence>
        </node>
        <view id="Particle-Blur">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" id="particle-color"/>
            <fullscreen-pass shader="regen.textures.sampling"/>
        </view>
    </node>

    <!--**************************-->
    <!--******* Collisions *******-->
    <!--**************************-->

    <!-- Render static objects into collision buffer at attachment 1. -->
    <node id="Collision-Initialize">
        <define key="OUTPUT_TYPE" value="WHITE"/>
        <cull mode="FRONT"/>
        <camera id="collision-camera"/>
        <depth test="0" write="0"/>
        <fbo id="collision-fbo" clear-buffers="1" draw-buffers="1"/>
        <node import="Static-Ground-Items"/>
    </node>

    <!-- Compose collision buffer attachment 0. First copy static objects from attachment 1,
         then add dynamic objects. -->
    <node id="Collision-Update">
        <node>
            <blit src-fbo="collision-fbo" src-attachment="1"
                  dst-fbo="collision-fbo" dst-attachment="0"/>
        </node>
        <node>
            <cull mode="FRONT"/>
            <define key="OUTPUT_TYPE" value="WHITE"/>
            <camera id="collision-camera"/>
            <depth test="0" write="0"/>
            <fbo id="collision-fbo" draw-buffers="0"/>
            <node import="Dynamic-Ground-Items"/>
        </node>
    </node>

    <!--**************************-->
    <!--********* Shading ********-->
    <!--**************************-->

    <node id="Shadow-Pass">
        <cull mode="FRONT"/>
        <define key="OUTPUT_TYPE" value="DEPTH"/>

        <node id="Room-Light-Shadow">
            <node id="Room-Light-Shadow0">
                <fbo id="room-light-shadow0" clear-depth="1"/>
                <camera id="room-light-camera0"/>
                <node import="Shadow-Caster"/>
            </node>
        </node>
    </node>

    <node id="Shading-Pass">
        <depth test="0" write="0"/>
        <input type="vec3" name="lightAmbient" value="0.3,0.3,0.3"/>
        <resource id="sky"/>

        <node id="Light-Shading">
            <node>
                <light-pass type="DIRECTIONAL" ambient="1" shader="regen.shading.deferred.directional">
                    <light id="sky-sun"/>
                </light-pass>
            </node>
            <node>
                <blend mode="add"/>
                <node>
                    <light-pass type="POINT" ambient="0"
                                shader="regen.shading.deferred.point.parabolic"
                                shadow-filter="PCF_GAUSSIAN">
                        <light id="room-light0"
                               shadow-buffer="room-light-shadow0" shadow-attachment="depth"
                               shadow-camera="room-light-camera0"/>
                    </light-pass>
                </node>
            </node>
        </node>
    </node>

    <!--**************************-->
    <!--********* Objects ********-->
    <!--**************************-->

    <node id="Static-Ground-Items">
        <node import="Pedestal"/>
        <node import="Garden-Items"/>
        <node import="Stairs"/>
    </node>

    <node id="Dynamic-Ground-Items">
        <node id="Dwarf">
            <node id="dwarf-body">
                <mesh id="dwarf-mesh" mesh-index-range="1-" shader="regen.objects.mesh"/>
            </node>
            <node id="dwarf-axe">
                <mesh id="dwarf-mesh" mesh-index="0" shader="regen.objects.mesh"/>
            </node>
        </node>
    </node>

    <node id="Shadow-Caster">
        <node import="Dynamic-Ground-Items"/>
        <node import="Static-Ground-Items"/>
        <node import="Platforms"/>
    </node>

    <node id="Non-Shadow-Caster">
        <node id="Ground">
            <mesh id="ground-mesh" primitive="triangles" shader="regen.objects.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="Post-Pass">
        <depth test="0" write="0"/>

        <node id="Albedo-Fog">
            <fbo id="g-buffer" draw-buffers="0"/>
            <input type="float" name="fogDensity" value="1.0"/>
            <input type="vec2" name="fogDistance" value="50.0,{{far-plane}}" min="0.0" max="{{far-plane}}"/>
            <input type="vec3" name="fogColor" value="0.2,0.33,0.3" schema="color"/>
            <input type="vec2" name="farDistance" value="75.0,{{far-plane}}"/>
            <input name="SunLight" state="sky-sun" component="Light" member-suffix="_Sun"/>
            <input type="vec3" name="warmTint" value="0.6, 0.4, 0.3" />
            <texture name="gDepthTexture" fbo="g-buffer" attachment="depth" />
            <texture name="gColorTexture" fbo="g-buffer" attachment="1"/>
            <texture name="skyColorTexture" id="sky" />
            <fullscreen-pass shader="regen.objects.sky.fog.distance"/>
        </node>
        <view id="Albedo-Fog">
            <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
        </view>
        <node import="Sky">
            <fbo id="g-buffer" draw-buffers="0"/>
        </node>
        <!-- blur the g-buffer attachment0 -->
        <node import="G-Buffer-Blur0"/>
        <!-- apply depth of field effect by mixing the blurred scene with the original scene -->
        <node import="Depth-of-Field">
            <fbo id="g-buffer" draw-buffers="1"/>
            <texture name="inputTexture" fbo="g-buffer" attachment="0"/>
            <texture name="blurTexture" id="blurred-scene"/>
            <input type="vec2" name="focalWidth" value="0.7,1.0" />
        </node>
        <view id="Depth of Field">
            <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
        </view>

        <!-- render particles into a separate buffer -->
        <node import="Particle-Update-FBO"/>
        <!-- render transparent objects -->
        <node id="Transparent-Pass">
            <fbo id="g-buffer" draw-buffers="1"/>
            <blend mode="add"/>
            <depth test="1" write="0"/>
            <!-- render emission light -->
            <node id="Material-Emission">
                <texture name="gEmissionTexture" fbo="g-buffer" attachment="4"/>
                <texture name="gEmissionBlurred" id="emission-map-bloom"/>
                <!-- <texture name="gEmissionBlurred" id="emission-map-blur" /> -->
                <fullscreen-pass shader="regen.shading.deferred.emission"/>
            </node>
            <!-- render particles -->
            <node id="Particle-Draw">
                <blend mode="alpha"/>
                <depth test="0" write="0"/>
                <texture name="inputTexture" id="particle-color"/>
                <define key="IS_2D_TEXTURE" value="TRUE"/>
                <fullscreen-pass shader="regen.textures.sampling"/>
            </node>
            <!-- <node import="Fire" /> -->
            <view id="Transparent Objects">
                <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
            </view>
        </node>

        <!-- apply anti-aliasing effect -->
        <node import="FXAA">
            <fbo id="g-buffer" draw-buffers="0"/>
            <texture name="inputTexture" fbo="g-buffer" attachment="1"/>
        </node>
        <view id="Antialiased Scene">
            <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
        </view>
    </node>

    <node id="initialize">
        <node import="Collision-Initialize"/>
    </node>

    <node id="root">
        <input name="Scene" ubo="SceneUBO"/>
        <resource id="sky"/>

        <node id="Pre-Render">
            <!-- Render shadow maps such that they can be used in the shading pass -->
            <node import="Shadow-Pass">
                <polygon offset-fill="1.1,4.0"/>
            </node>
            <view id="Parabolic Shadow-Map">
                <fbo id="SCREEN"/>
                <texture name="inputTexture" fbo="room-light-shadow0" attachment="depth"/>
                <input type="int" name="arrayTextureSize" value="1"/>
                <fullscreen-pass shader="regen.textures.sampling.array.shadow"/>
            </view>

            <node import="Collision-Update" />
            <view id="Collision Map">
                <fbo id="SCREEN"/>
                <texture name="inputTexture1" fbo="collision-fbo" attachment="0"/>
                <texture name="inputTexture2" fbo="collision-fbo" attachment="1"/>
                <fullscreen-pass shader="regen.textures.sampling.x2"/>
            </view>
        </node>

        <node id="Render">
            <fbo id="g-buffer" clear-buffers="0,1,2,3,4" clear-depth="1"/>
            <camera id="main-camera"/>

            <node id="Geometry-Pass">
                <fbo id="g-buffer" draw-buffers="0,1,2,3,4"/>
                <depth test="1" write="1"/>
                <node import="Shadow-Caster"/>
                <node import="Non-Shadow-Caster"/>
                <view id="G-Buffer: Emission">
                    <blit src-fbo="g-buffer" src-attachment="4" dst-fbo="SCREEN"/>
                </view>
                <node import="G-Buffer-Views"/>
            </node>

            <node id="Post-Geometry">
                <node id="Emission-Fog">
                    <depth test="0" write="0"/>
                    <fbo id="g-buffer" draw-buffers="1"/>
                    <input type="float" name="fogDensity" value="1.0"/>
                    <input type="vec2" name="fogDistance" value="50.0,{{far-plane}}" min="0.0" max="{{far-plane}}"/>
                    <input type="vec3" name="fogColor" value="0,0,0" schema="color"/>
                    <input type="vec2" name="farDistance" value="75.0,{{far-plane}}"/>
                    <texture name="gDepthTexture" fbo="g-buffer" attachment="depth" />
                    <texture name="gColorTexture" fbo="g-buffer" attachment="4"/>
                    <fullscreen-pass shader="regen.objects.sky.fog.distance"/>
                </node>
                <node id="Emission-Update">
                    <input type="float" name="filterRadius" value="0.01"/>
                    <bloom fbo="g-buffer" attachment="1" bloom-texture="emission-map-bloom"/>
                </node>
                <node id="Shaded Scene">
                    <!-- NOTE: this blit could be avoided by rendering emission into attachment 1 of g-buffer
                               and then computing fog in attachment 4. Or switch back to GL blending instead of
                               blending in the shader. -->
                    <blit src-fbo="g-buffer" src-attachment="1"
                          dst-fbo="g-buffer" dst-attachment="4"/>
                </node>
                <view id="Emission Mips">
                    <fbo id="SCREEN"/>
                    <texture name="inputTexture1" id="emission-map-bloom" mip-level="0"/>
                    <texture name="inputTexture2" id="emission-map-bloom" mip-level="1"/>
                    <texture name="inputTexture3" id="emission-map-bloom" mip-level="2"/>
                    <texture name="inputTexture4" id="emission-map-bloom" mip-level="3"/>
                    <fullscreen-pass shader="regen.textures.sampling.x4"/>
                </view>
                <!--
                <node id="Emission-Blur">
                    <input type="int" name="numBlurPixels" value="4" />
                    <input type="float" name="blurSigma" value="2.0" />
                    <filter-sequence id="emission-map-blur" fbo="g-buffer" attachment="4" >
                        <filter shader="regen.textures.sampling" scale="0.5" />
                        <filter shader="regen.passes.blur.horizontal" />
                        <filter shader="regen.passes.blur.vertical" />
                    </filter-sequence>
                </node>
                -->
            </node>

            <node id="Shading">
                <fbo id="g-buffer" draw-buffers="1"/>
                <node id="Light-Pass">
                    <texture name="gDepthTexture" fbo="g-buffer" attachment="depth"/>
                    <texture name="gDiffuseTexture" fbo="g-buffer" attachment="0"/>
                    <texture name="gSpecularTexture" fbo="g-buffer" attachment="2"/>
                    <texture name="gNorWorldTexture" fbo="g-buffer" attachment="3"/>
                    <node import="Shading-Pass"/>
                </node>
                <view id="Shaded Scene">
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </view>
            </node>

            <node import="Post-Pass"/>

            <view id="Bullet Debug">
                <node import="bullet-debug">
                    <fbo id="g-buffer" draw-buffers="0"/>
                </node>
                <node>
                    <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
                </node>
            </view>
            <view id="Spatial Index">
                <node import="spatial-index-debug">
                    <fbo id="g-buffer" draw-buffers="0"/>
                </node>
                <node>
                    <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
                </node>
            </view>

            <node import="GUI-Pass">
                <fbo id="g-buffer" draw-buffers="0"/>
            </node>

            <view id="Output Rendering">
                <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
            </view>
        </node>
    </node>
</node>
