<?xml version="1.0" encoding="UTF-8" ?>

<node>
    <constant name="num-cascades" value="4"/>

    <include xml-file="scene-display/examples/templates/default.xml"/>
    <node id="configuration"
          date="01-09-2014 06:00:00"
          time-scale="60.0">
        <controller type="user-impulse"
                mode="third-person" camera="main-camera"
                mesh="sphere-mesh0" mesh-distance="26.0"
                vertical-orientation="0.4"
                transform="sphere0-tf"
                eye-offset="0.0,0.0,0.0"
                eye-orientation="3.14159265359">
        </controller>
    </node>

    <!-- FBOs -->
    <fbo id="g-buffer"
         size-mode="rel" size="1.0,1.0"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="tmp"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <depth id="depth" pixel-size="24"/>
    </fbo>
    <fbo id="emission-fbo" size-mode="rel" size="0.25, 0.25"
         pixel-type="FLOAT" pixel-size="24">
        <texture id="color" pixel-components="4"/>
        <depth id="depth"/>
    </fbo>
    <fbo id="sun-shadow" size-mode="abs" size="2048,2048,{{num-cascades}}">
        <depth id="depth" pixel-size="24" pixel-type="FLOAT"
               target="TEXTURE_2D_ARRAY"
               wrapping="REPEAT"
               min-filter="NEAREST"
               mag-filter="NEAREST"
               compare-mode="COMPARE_R_TO_TEXTURE"
               compare-function="LEQUAL"
               sampler-type="sampler2DArrayShadow"/>
    </fbo>
    <fbo id="cube-reflection-buffer"
         size-mode="abs" size="256,256,6"
         wrapping="REPEAT"
         target="TEXTURE_CUBE_MAP"
         sampler-type="samplerCube"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="ambient"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <depth pixel-size="24"/>
    </fbo>
    <fbo id="cube-emission-fbo"
         size-mode="abs" size="128,128,6"
         target="TEXTURE_CUBE_MAP"
         sampler-type="samplerCube"
         pixel-type="FLOAT" pixel-size="24">
        <texture id="color" pixel-components="4"/>
        <depth id="depth"/>
    </fbo>
    <fbo id="paraboloid-reflection-buffer"
         size-mode="abs" size="512,512,2"
         wrapping="CLAMP_TO_EDGE"
         target="TEXTURE_2D_ARRAY"
         sampler-type="sampler2DArray"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="ambient"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <depth pixel-size="24"/>
    </fbo>
    <!-- Textures -->
    <texture id="reflector-noise" type="noise" preset="perlin" noise-scale="4.0"
            size="2048.0,2048.0,1.0" swizzle-g="RED" swizzle-b="RED"/>
    <!-- Spatial Index -->
    <index id="main-index" type="quadtree"
            max-objects-per-node="4"
            test-mode-3d="closest"
            close-distance="20.0"/>
    <!-- Cameras -->
    <camera id="main-camera"
            fov="45.0" near="0.1" far="200.0"
            position="0.0,1.5,-8.0"
            direction="0.0,-0.25,1.0">
        <culling index="main-index" />
    </camera>
    <camera id="sun-camera" light="sky-sun"
            camera="main-camera"
            lod-shift="1,1,1,0"
            num-layer="{{num-cascades}}"
            split-weight="0.9">
        <culling index="main-index" />
    </camera>
    <camera id="paraboloid-camera"
            type="paraboloid"
            tf="sphere0-tf">
        <culling index="main-index" />
    </camera>
    <camera id="cube-camera"
            type="cube"
            tf="sphere1-tf">
        <culling index="main-index" />
    </camera>
    <!-- Sky -->
    <sky id="sky" camera="main-camera" update-interval="200.0">
        <star-map texture="res/sky/milkyway.png" scattering="0.8" delta-magnitude="0.05" lod="4"/>
        <stars catalog="res/sky/bright-stars.bin" scale="1.4"
               scattering="1.0" scintillation="0.2" apparent-magnitude="6.0"
               glare-intensity="0.04" glare-scale="0.2"
               color="0.66,0.78,1.0" color-ratio="0.66"/>
        <moon texture="res/sky/moon.png" scale="0.04" scattering="4.0"
              sun-shine-color="0.923,0.786,0.636" sun-shine-intensity="128.0"
              earth-shine-color="0.88,0.96,1.0" earth-shine-intensity="8.0"/>
        <atmosphere preset="earth" size="256" lod="4">
            <input type="float" name="cirrus" value="0.8"/>
            <input type="float" name="cumulus" value="1.0"/>
            <input type="float" name="dithering" value="0.2"/>
            <input type="float" name="ditheringScale" value="100.0"/>
            <input type="float" name="cloudTimeFactor" value="0.3"/>
        </atmosphere>
    </sky>

    <!--**************************-->
    <!--* meshes  *-->
    <!--**************************-->

    <transform id="bowl-tf">
        <translate value="0.0,-1.0,0.0"/>
    </transform>

    <mesh id="bowl"
          type="half-sphere"
          lod="6"
          scaling="10.0,1.5,10.0"
          texco-scaling="5.0,5.0"
          use-normal="1"
          use-tangent="0"
          update-frequency="NEVER">
        <define key="HAS_TWO_SIDES" value="TRUE"/>
        <material preset="iron"/>
        <transform id="bowl-tf"/>
        <shape id="bowl-physics" physics="1" shape="triangle-mesh" mass="0.0"
               mesh-id="bowl" transform-id="bowl-tf"/>
    </mesh>

    <transform id="sphere0-tf">
        <translate value="-1.45,3.0,0.0"/>
    </transform>

    <mesh id="sphere-mesh0"
          type="sphere"
          lod="4"
          scaling="1.0,1.0,1.0"
          texco-scaling="1.0,1.0"
          use-normal="1"
          use-tangent="0"
          update-frequency="NEVER">
        <transform id="sphere0-tf"/>
        <shape id="sphere0-physics" physics="1" shape="sphere"
               radius="1.0" mass="1.0" inertia="0.0,-1.0,0.0" friction="0.0"
               mesh-id="sphere-mesh0" transform-id="sphere0-tf"/>
    </mesh>

    <transform id="sphere1-tf">
        <translate value="2.0,3.5,0.0"/>
    </transform>

    <mesh id="sphere-mesh1"
          type="sphere"
          lod="4"
          scaling="1.0,1.0,1.0"
          texco-scaling="1.0,1.0"
          use-normal="1"
          use-tangent="0"
          update-frequency="NEVER">
        <material preset="ruby" update-frequency="NEVER"/>
        <transform id="sphere1-tf"/>
        <shape id="sphere1-physics" physics="1" shape="sphere"
               radius="1.0" mass="20.0" inertia="0.0,-1.0,0.0" friction="0.0"
               mesh-id="sphere-mesh1" transform-id="sphere1-tf"/>
    </mesh>

    <transform id="sphere2-tf" num-instances="40" is-instanced="1">
        <set mode="row" target="translate"
             x-step="0.5,0.0,0.0" x-count="5"
             z-step="0.0,0.0,0.5"/>
        <translate value="-2.0,1.5,-1.0"/>
    </transform>

    <mesh id="sphere-mesh2"
          type="sphere"
          lod="4"
          scaling="0.5,0.5,0.5"
          texco-scaling="1.0,1.0"
          use-normal="1"
          use-tangent="0"
          update-frequency="NEVER"
          num-instances="40">
        <material preset="copper" update-frequency="NEVER"/>
        <transform id="sphere2-tf"/>
        <shape id="sphere2-physics" physics="1" shape="sphere"
               radius="0.5" mass="0.4" inertia="0.0,0.0,0.0" friction="0.0"
               mesh-id="sphere-mesh2" transform-id="sphere2-tf"/>
    </mesh>

    <!--**************************-->
    <!--* paraboloid reflection  *-->
    <!--**************************-->

    <node id="Paraboloid-Reflector">
        <define key="IS_PARABOLOID_DUAL" value="TRUE"/>
        <define key="SHADING" value="NONE"/>
        <material ambient="1.0,1.0,1.0" diffuse="0.0,0.0,0.0"/>
        <input name="ReflectionCamera" state="paraboloid-camera" component="Camera" member-suffix="_Reflection"/>
        <texture fbo="paraboloid-reflection-buffer" attachment="1"
                 map-to="COLOR"
                 blend-mode="SRC"
                 mapping="PARABOLOID_REFLECTION"/>
        <mesh id="sphere-mesh0" shader="regen.models.mesh"/>
    </node>

    <node id="Paraboloid-Reflection-Update">
        <camera id="paraboloid-camera"/>
        <node>
            <depth test="1" write="1"/>
            <fbo id="paraboloid-reflection-buffer"
                    clear-buffers="0,1,2,3" clear-depth="1"
                    draw-buffers="0,1,2,3"/>
            <node import="Shadow-Caster"/>
            <node import="Scene-Geometry"/>
        </node>
        <node>
            <fbo id="paraboloid-reflection-buffer" draw-buffers="1"/>
            <node>
                <texture name="gDepthTexture" fbo="paraboloid-reflection-buffer" attachment="depth"/>
                <texture name="gDiffuseTexture" fbo="paraboloid-reflection-buffer" attachment="0"/>
                <texture name="gSpecularTexture" fbo="paraboloid-reflection-buffer" attachment="2"/>
                <texture name="gNorWorldTexture" fbo="paraboloid-reflection-buffer" attachment="3"/>
                <node import="Shading-Pass"/>
            </node>
            <node import="Paraboloid-Background-Pass"/>
            <node import="Cube-Reflector"/>
        </node>
    </node>

    <!--**************************-->
    <!--**** Cube reflection *****-->
    <!--**************************-->

    <node id="Cube-Reflector">
        <define key="SHADING" value="NONE"/>
        <material ambient="1.0,1.0,1.0" diffuse="0.0,0.0,0.0"/>
        <texture fbo="cube-reflection-buffer" attachment="1"
                 map-to="COLOR"
                 blend-mode="SRC"
                 mapping="CUBE_REFLECTION"/>
        <mesh id="sphere-mesh1" shader="regen.models.mesh"/>
    </node>

    <node id="Cube-Reflection-Update">
        <camera id="cube-camera"/>
        <node id="Cube-Geometry-Pass">
            <depth test="1" write="1"/>
            <fbo id="cube-reflection-buffer" clear-buffers="0,1,2,3" clear-depth="1" draw-buffers="0,1,2,3"/>
            <node import="Shadow-Caster"/>
            <node import="Scene-Geometry"/>
        </node>
        <node id="Cube-Shading-Pass">
            <fbo id="cube-reflection-buffer" draw-buffers="1"/>
            <node>
                <texture name="gDepthTexture" fbo="cube-reflection-buffer" attachment="depth"/>
                <texture name="gDiffuseTexture" fbo="cube-reflection-buffer" attachment="0"/>
                <texture name="gSpecularTexture" fbo="cube-reflection-buffer" attachment="2"/>
                <texture name="gNorWorldTexture" fbo="cube-reflection-buffer" attachment="3"/>
                <node import="Shading-Pass"/>
            </node>
            <node import="Cube-Background-Pass"/>
            <node import="Paraboloid-Reflector"/>
        </node>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="Reflectors">
        <depth test="1" write="1"/>
        <node import="Paraboloid-Reflector"/>
        <node import="Cube-Reflector"/>
    </node>

    <!--**************************-->
    <!--********* Rain ***********-->
    <!--**************************-->

    <mesh id="rain-particles"
          type="particles"
          num-vertices="50000"
          update-shader="regen.weather.rain.update">
        <!-- Add shader input. -->
        <input type="vec3" name="gravity" value="-0.8,-4.5,0" min="-30,-30,-30" max="30,30,30" />
        <input type="vec3" name="initialVelocity" value="0.5,0.75,0.5" min="-30,-30,-30" max="30,30,30" />
        <input type="vec2" name="initialBrightness" value="3.0,1.0"/>
        <input type="vec2" name="emitterCone" value="60.0,30.0"/>
        <input name="Camera" state="main-camera" component="Camera"/>
        <!-- Add particle attributes. -->
        <input type="vec3" name="pos" is-attribute="1"/>
        <input type="vec3" name="velocity" is-attribute="1"/>
        <input type="int" name="type" is-attribute="1"/>
        <input type="float" name="brightness" is-attribute="1"/>
    </mesh>

    <node id="Rain">
        <direct-shading ambient="0.3,0.3,0.3">
            <direct-lights>
                <light id="sky-sun"/>
                <light id="sky-moon"/>
            </direct-lights>
            <direct-pass>
                <node id="particle-draw">
                    <blend mode="add"/>
                    <depth test="1" write="0"/>
                    <define key="USE_RAIN_DB" value="TRUE"/>
                    <texture name="rainDB" id="rain-database"/>
                    <input type="vec2" name="particleSize" value="0.1,5.0"/>
                    <mesh id="rain-particles" shader="regen.weather.rain.draw"/>
                </node>
            </direct-pass>
        </direct-shading>
    </node>

    <!--**************************-->
    <!--******* Flying spheres ********-->
    <!--**************************-->
    <transform id="stone-ring-tf" num-instances="20" is-instanced="1">
        <rotate value="0.0, 0.0, 0.0"/>
        <translate value="0.0, 5.6, 0.0"/>
        <set mode="circle" target="translate" radius="6.0" variance="0.1"
                 dir-x="1.0, 0.0, 0.0" dir-z="0.0, 0.0, 1.0"/>
    </transform>

    <mesh id="stone-ring" type="sphere"
            use-normal="1" use-texco="1" use-tangent="1"
            lod-levels="5, 4, 3, 2"
            lod-thresholds="20.0, 50.0, 80.0"
            scaling="0.2,0.2,0.2"
            update-frequency="NEVER">
        <shader mesh-index="0" key="regen.models.mesh" />
        <transform id="stone-ring-tf" />
        <material preset="stone" variant="0" max-offset="0.2" update-frequency="NEVER"
                color-blend-mode="mul" diffuse="0.646662, 0.555062, 0.42034" />
        <shape id="stone-ring-shape" index="1" cull="1" type="sphere"
               mesh-id="stone-ring" transform-id="stone-ring-tf" radius="1.6"/>
    </mesh>

    <!--**************************-->
    <!--******* Lightning ********-->
    <!--**************************-->

    <mesh id="lightning-mesh" type="lightning"
          update-frequency="PER_FRAME" update-scope="FULL">
        <shader mesh-index="0" key="regen.weather.lightning" />
        <strike num-subdivisions="7" jitter-offset="12.0"
                max-branches="12" branch-probability="0.9" branch-offset="16.0"
                frequency="1.1f, 1.0f" lifetime="0.35f, 0.15f"
                source-constant="10.0, 60.0, 30.0"
                target-constant="0.0, -40.0, 30.0"/>
        <strike num-subdivisions="7" jitter-offset="12.0"
                max-branches="12" branch-probability="0.9" branch-offset="16.0"
                frequency="1.1f, 1.0f" lifetime="0.35f, 0.15f"
                source-constant="-10.0, 60.0, -30.0"
                target-constant="0.0, -40.0, -30.0"/>
        <strike num-subdivisions="5" jitter-offset="2.0" width-factor="0.15"
                max-branches="6" branch-probability="0.6" branch-offset="1.0"
                frequency="0.0f, 0.0f" lifetime="0.7f, 0.3f"
                ring-strength="4" ring-tf="stone-ring-tf"/>
        <strike num-subdivisions="4" jitter-offset="1.0" width-factor="0.1"
                max-branches="4" branch-probability="0.4" branch-offset="1.0"
                frequency="0.0f, 0.0f" lifetime="0.2f, 0.1f"
                ring-strength="2" ring-tf="sphere2-tf"/>
        <strike num-subdivisions="6" jitter-offset="3.0" width-factor="0.2"
                max-branches="11" branch-probability="0.7" branch-offset="4.0"
                frequency="10.1f, 5.0f" lifetime="0.95f, 0.3f"
                source-tf="stone-ring-tf"
                target-tf="sphere2-tf" target-randomize="1"/>
    </mesh>

    <node id="Emission-Draw">
        <depth test="1" write="0"/>
        <blend mode="lighten"/>
        <node id="Lightning-Bolt0">
            <input type="float" name="lightningWidth" value="0.6"/>
            <input type="vec3" name="matDiffuse" value="0.8, 1.5, 20.0"/>
            <mesh id="lightning-mesh"/>
        </node>
    </node>

    <node id="G-Buffer-Emission-Update">
        <node id="Copy-Depth">
            <depth test="1" write="1"/>
            <fbo id="emission-fbo" clear-depth="1"/>
            <texture name="inputTexture" fbo="g-buffer" attachment="depth"/>
            <fullscreen-pass shader="regen.filter.sampling.downsample.depth"/>
        </node>
        <node id="G-Buffer-Emission-Draw">
            <fbo id="emission-fbo" clear-buffers="0" draw-buffers="0"/>
            <node import="Emission-Draw" />
        </node>
        <node id="Emission-Blur">
            <input type="int" name="numBlurPixels" value="9"/>
            <input type="float" name="blurSigma" value="5.0"/>
            <filter-sequence id="emission-color" fbo="emission-fbo" attachment="0">
                <filter shader="regen.filter.blur.horizontal"/>
                <filter shader="regen.filter.blur.vertical"/>
            </filter-sequence>
        </node>
    </node>

    <node id="Emission-Draw-Lightning-Bolt">
        <depth test="1" write="0"/>
        <input type="float" name="lightningWidth" value="0.15"/>
        <input type="vec3" name="matDiffuse" value="1.0, 1.0, 1.0"/>
        <mesh id="lightning-mesh"/>
    </node>

    <node id="Emission-Draw-Glow">
        <depth test="0" write="0"/>
        <fullscreen-pass shader="regen.filter.sampling"/>
    </node>

    <node id="G-Buffer-Emission-Draw">
        <blend mode="alpha"/>
        <node import="Emission-Draw-Lightning-Bolt" />
        <node import="Emission-Draw-Glow">
            <texture name="inputTexture" id="emission-color"/>
        </node>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="Scene-Geometry">
        <node id="Bowl">
            <toggle key="CULL_FACE" value="0"/>
            <texture name="noiseTexture" id="reflector-noise" map-to="COLOR" blend-mode="ADD" />
            <mesh id="bowl" shader="regen.models.mesh"/>
        </node>
    </node>

    <node id="Shadow-Caster">
        <node id="Instanced-Spheres">
            <mesh id="sphere-mesh2" shader="regen.models.mesh"/>
        </node>
        <!--
        <mesh id="sphere-mesh0" shader="regen.models.mesh" />
        <mesh id="sphere-mesh1" shader="regen.models.mesh" />
        -->
        <node id="Stones">
            <mesh id="stone-ring" mesh-index="0" update-visibility="1"/>
        </node>
    </node>

    <!--**************************-->
    <!--***** Shadow Mapping *****-->
    <!--**************************-->

    <node id="Shadow-Pass">
        <cull mode="FRONT"/>
        <define key="OUTPUT_TYPE" value="DEPTH"/>

        <node id="Sun-Shadow">
            <fbo id="sun-shadow" clear-depth="1"/>
            <camera id="sun-camera"/>
            <node import="Shadow-Caster"/>
        </node>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="Shading-Pass">
        <depth test="0" write="0"/>
        <input type="vec3" name="lightAmbient" value="0.3,0.3,0.3"/>
        <resource id="sky"/>

        <node id="Light-Shading">
            <!-- <define key="DEBUG_SHADOW_SLICES" value="1" /> -->
            <light-pass type="DIRECTIONAL" ambient="1"
                        shader="regen.shading.deferred.directional"
                        shadow-filter="PCF_GAUSSIAN">
                <light id="sky-sun"
                       shadow-buffer="sun-shadow"
                       shadow-attachment="depth"
                       shadow-camera="sun-camera"/>
            </light-pass>
        </node>
    </node>

    <node id="Background-Pass">
        <node id="Sky">
            <depth test="1" write="0"/>
            <sky id="sky"/>
        </node>
        <node import="Reflectors"/>
        <node import="Rain">
            <texture name="depthTexture" fbo="g-buffer" attachment="depth"/>
        </node>

        <node import="G-Buffer-Emission-Update"/>

        <node id="Transparent-Pass">
            <blend mode="add"/>
            <depth test="1" write="0"/>
            <node import="G-Buffer-Emission-Draw" />
        </node>
    </node>

    <node id="Cube-Background-Pass">
        <node id="Sky">
            <depth test="1" write="0"/>
            <sky id="sky"/>
        </node>
        <!--
        <node import="Rain">
            <texture name="depthTexture" fbo="cube-reflection-buffer" attachment="depth"/>
        </node>
        -->
        <!-- TODO: Add lightning to the reflection buffer.
                - For some reason the bolt does not render into cube map.
                - Seems not the shader.
                - Maybe something regarding the vertex data update? the vertex data is not really in place initially
                  when copies are created.
        -->
        <!--
        <node id="Cube-Emission-Update">
            <node id="Cube-Emission-Depth">
                <depth test="1" write="1"/>
                <fbo id="cube-emission-fbo" clear-depth="1"/>
                <texture name="inputTexture" fbo="cube-reflection-buffer" attachment="depth"/>
                <fullscreen-pass shader="regen.filter.sampling.downsample.depth"/>
            </node>
            <node id="Cube-Emission-Draw">
                <fbo id="cube-emission-fbo" clear-buffers="0" draw-buffers="0"/>
                <depth test="1" write="0"/>
                <blend mode="lighten"/>
                <node id="Lightning-Bolt0">
                    <input type="float" name="lightningWidth" value="0.6"/>
                    <input type="vec3" name="matDiffuse" value="0.8, 1.5, 20.0"/>
                    <mesh id="lightning-mesh"/>
                </node>
            </node>
            <node id="Cube-Emission-Blur">
                <input type="int" name="numBlurPixels" value="9"/>
                <input type="float" name="blurSigma" value="5.0"/>
                <filter-sequence id="cube-emission-color" fbo="cube-emission-fbo" attachment="0">
                    <filter shader="regen.filter.blur.horizontal"/>
                    <filter shader="regen.filter.blur.vertical"/>
                </filter-sequence>
            </node>
        </node>

        <view id="Cube-Emission-Color">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" fbo="cube-emission-fbo" attachment="0"/>
            <fullscreen-pass shader="regen.filter.sampling.cube"/>
        </view>
        <view id="Cube-Emission-Blurred">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" id="cube-emission-color"/>
            <fullscreen-pass shader="regen.filter.sampling.cube"/>
        </view>
        <node id="Cube-Transparent-Pass">
            <blend mode="add"/>
            <depth test="1" write="0"/>
            <node id="Cube-Emission-Draw">
                <blend mode="alpha"/>
                <node import="Emission-Draw-Lightning-Bolt" />
                <node import="Emission-Draw-Glow">
                    <texture name="inputTexture" id="cube-emission-color"/>
                </node>
            </node>
        </node>
        -->
    </node>

    <node id="Paraboloid-Background-Pass">
        <node id="Sky">
            <depth test="1" write="0"/>
            <sky id="sky"/>
        </node>
    </node>

    <node id="Post-Pass">
        <depth test="0" write="0"/>

        <node import="FXAA">
            <fbo id="g-buffer" draw-buffers="0"/>
            <texture name="inputTexture" fbo="g-buffer" attachment="1"/>
        </node>
        <view id="Scene -- Antialiased">
            <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
        </view>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="Debug-Views">
        <view id="Paraboloid Reflection">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" fbo="paraboloid-reflection-buffer" attachment="1"/>
            <input type="int" name="arrayTextureSize" value="2"/>
            <fullscreen-pass shader="regen.filter.sampling.array"/>
        </view>
        <view id="Cube Reflection">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" fbo="cube-reflection-buffer" attachment="1"/>
            <fullscreen-pass shader="regen.filter.sampling.cube"/>
        </view>
        <view id="Emission-Color">
            <blit src-fbo="emission-fbo" src-attachment="0" dst-fbo="SCREEN"/>
        </view>
        <view id="Emission-Blur">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" id="emission-color"/>
            <fullscreen-pass shader="regen.filter.sampling"/>
        </view>
        <view id="Bullet-Debug">
            <node import="bullet-debug">
                <fbo id="g-buffer" draw-buffers="0"/>
            </node>
            <node>
                <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
            </node>
        </view>
    </node>

    <node id="root">
        <resource id="sky"/>
        <input type="float" name="surfaceHeight" value="0.0"/>

        <node id="Pre-Render">
            <node import="Shadow-Pass"/>
            <node import="Paraboloid-Reflection-Update"/>
            <node import="Cube-Reflection-Update"/>
        </node>

        <node id="Render">
            <fbo id="g-buffer" clear-buffers="0,1,2,3" clear-depth="1"/>

            <camera id="main-camera"/>

            <node id="Geometry-Pass">
                <depth test="1" write="1"/>
                <fbo id="g-buffer" draw-buffers="0,1,2,3"/>

                <node import="Shadow-Caster"/>
                <node import="Scene-Geometry"/>
                <view id="Scene -- Diffuse">
                    <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
                </view>
                <view id="Scene -- Ambient">
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </view>
                <view id="Scene -- Specular">
                    <blit src-fbo="g-buffer" src-attachment="2" dst-fbo="SCREEN"/>
                </view>
                <view id="Scene -- Normal">
                    <blit src-fbo="g-buffer" src-attachment="3" dst-fbo="SCREEN"/>
                </view>
            </node>

            <node id="Shading">
                <fbo id="g-buffer" draw-buffers="1"/>

                <node id="Light-Pass">
                    <texture name="gDepthTexture" fbo="g-buffer" attachment="depth"/>
                    <texture name="gDiffuseTexture" fbo="g-buffer" attachment="0"/>
                    <texture name="gSpecularTexture" fbo="g-buffer" attachment="2"/>
                    <texture name="gNorWorldTexture" fbo="g-buffer" attachment="3"/>

                    <node import="Shading-Pass"/>
                </node>

                <view id="Scene -- Shading">
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </view>

                <node import="Background-Pass"/>
                <view id="Scene -- Background">
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </view>

                <node import="Post-Pass"/>
            </node>
            <node import="Debug-Views"/>

            <node import="GUI-Pass">
                <fbo id="g-buffer" draw-buffers="0"/>
            </node>
            <view id="Scene -- Result">
                <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
            </view>
        </node>
    </node>
</node>
