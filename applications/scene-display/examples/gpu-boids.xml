<?xml version="1.0" encoding="UTF-8" ?>

<node>
    <constant name="map-size" value="1000.0"/>
    <constant name="map-height" value="24.0"/>
    <constant name="map-y-min" value="-12.0"/>
    <constant name="water-level" value="1.7"/>
    <constant name="num-fish" value="100000"/>
    <constant name="far-plane" value="200.0"/>
    <constant name="far-plane*0.5" value="100.0"/>

    <include xml-file="scene-display/examples/templates/default.xml"/>
    <node id="configuration"
            date="01-09-2014 06:00:00"
            time-scale="60.0">
        <camera id="main-camera"
                mode="first-person"
                speed="0.05"
                eye-offset="0.0,0.0,0.0"
                horizontal-orientation="4.71225"
                vertical-orientation="0.25"
                ease-in-out="1.8"
                anchor-pause-time="0.7"
                anchor-time-scale="0.8">
        </camera>
    </node>

    <!-- FBO for deferred shading -->
    <fbo id="g-buffer"
         size-mode="rel" size="1.0,1.0"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="ambient"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <texture id="emission" pixel-components="3"/>
        <depth pixel-size="24"/>
    </fbo>
    <fbo id="reflection-buffer"
         size="512, 512"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="ambient"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <depth id="depth" pixel-size="24"/>
    </fbo>
    <!-- Textures -->
    <texture id="emission-map-bloom" type="bloom" num-mips="4" input-fbo="g-buffer"/>
    <texture id="ground-color" file="res/textures/terrain/canyon/diffuse.png"/>
    <texture id="ground-normal" file="res/textures/terrain/canyon/normal.png"/>
    <texture id="ground-height" file="res/textures/terrain/canyon/height.png"/>
    <texture id="grass-mask" file="res/textures/terrain/canyon/mask-grass.png"/>
    <texture id="grass-color" file="res/textures/materials/grass/0/color.png" wrapping="REPEAT" />
    <texture id="wind-flowmap" file="res/textures/wind/flowmap0.png" wrapping="REPEAT"/>
    <texture id="wind-noise" type="noise" preset="cloud"
            size="128.0,128.0,1.0" swizzle-g="RED" swizzle-b="RED"/>
    <!-- Spatial Index -->
    <index id="main-index" type="quadtree" max-objects-per-node="4"/>
    <!-- Cameras -->
    <camera id="main-camera"
            culling-index="main-index"
            fov="45.0" near="0.1" far="200.0"
            position="-40.0, 14.0, 0.0"/>
    <camera id="reflection-camera"
            culling-index="main-index"
            lod-shift="1,1,1,0"
            camera="main-camera"
            reflector-normal="0,1,0"
            reflector-point="0,{{water-level}},0"/>
    <!-- Assets -->
    <asset id="fish-asset" type="asset"
           file="res/models/fish-puffer/PufferFish.fbx"
           ignore-normal-map="1">
    </asset>
    <!-- UBOs -->
    <block type="ubo" id="SceneUBO" update-frequency="NEVER">
        <uniform name="planeSize" type="vec2" value="{{map-size}}, {{map-size}}"/>
        <uniform name="wind" type="vec2" value="0.6, 0.6"/>
        <uniform name="windFlowScale" type="float" value="50.0"/>
        <uniform name="windFlowTime" type="float" value="0.1"/>
        <uniform name="windStrength" type="float" value="1.0"/>
    </block>
    <!-- Sky -->
    <sky id="sky" camera="main-camera" update-interval="200.0" >
        <star-map texture="res/sky/milkyway.png" scattering="0.2" delta-magnitude="0.01" lod="0" />
        <stars catalog="res/sky/bright-stars.bin" scale="1.4"
            scattering="1.0" scintillation="0.2" apparent-magnitude="6.0"
            glare-intensity="0.04" glare-scale="0.2"
            color="0.66,0.78,1.0" color-ratio="0.8"/>
        <moon texture="res/sky/moon.png" scale="0.04" scattering="4.0"
            sun-shine-color="0.923,0.786,0.636" sun-shine-intensity="128.0"
            earth-shine-color="0.88,0.96,1.0" earth-shine-intensity="8.0" />
        <atmosphere preset="earth" size="256" lod="0">
            <input type="float" name="cirrus" value="0.8" />
            <input type="float" name="cumulus" value="0.6" />
            <input type="float" name="dithering" value="0.2" />
            <input type="float" name="ditheringScale" value="100.0" />
            <input type="float" name="cloudTimeFactor" value="0.3" />
        </atmosphere>
    </sky>
    <node id="Sky">
        <sky id="sky"/>
    </node>

    <!--**************************-->
    <!--****** Ground mesh *******-->
    <!--**************************-->

    <mesh id="ground-mesh"
          type="ground"
          lod-levels="6,5,4,2"
          lod-thresholds="40.0, 80.0, 120.0"
          patch-density="35"
          map-size="{{map-size}},{{map-height}},{{map-size}}"
          map-center="0.0,0.0,0.0"
          skirt-size="1.4"
          weight-map-size="2024"
          weight-mips="1"
          triplanar-blending="1"
          height-map="ground-height"
          normal-map="ground-normal"
          tf="ground-tf">
        <shader mesh-index="0" key="regen.terrain.ground"/>
        <shader mesh-index="1" key="regen.terrain.ground.skirt"/>
        <transform id="ground-tf" update-frequency="NEVER" />
        <materials>
            <material type="grass" name="ground/grass" variant="1" uv-scale="0.25"
                    height="0.25, 0.75, 0.25" slope="0.0, 25.0, 10.0"/>
            <material type="rock" name="ground/stone" variant="8" uv-scale="0.1"
                    slope="30.0, 180.0, 30.0"/>
            <material type="sand" name="ground/sand" variant="3" uv-scale="0.05"
                    height="0.0, 0.3, 0.2" slope="0.0, 15.0, 15.0"/>
            <material type="dirt" name="ground/dirt" variant="1" uv-scale="0.5" is-fallback="1"
                    height="0.0, 0.75, 0.2" slope="10.0, 180.0, 20.0"/>
        </materials>
        <shape id="ground-shape" cull="1" index="1" type="obb" mesh-index="0"
            mesh-id="ground-mesh" transform-id="ground-tf">
            <has-part mesh-id="ground-mesh" mesh-index="1" />
        </shape>
    </mesh>

    <node id="Ground">
        <node id="Ground-quad">
            <mesh id="ground-mesh" mesh-index="0"/>
        </node>
        <node id="Ground-skirts">
            <mesh id="ground-mesh" mesh-index="1" update-visibility="0"/>
        </node>
    </node>

    <!--**************************-->
    <!--**** Water Reflection ****-->
    <!--**************************-->

    <node id="Reflection-Pass">
        <!-- need to load the resource before the reflection pass -->
        <camera id="reflection-camera"/>
        <fbo id="reflection-buffer" clear-buffers="0,1,2,3" clear-depth="1"/>

        <node>
            <depth test="1" write="1"/>
            <fbo id="reflection-buffer" draw-buffers="0,1,2,3"/>
            <node import="Shadow-Caster"/>
            <node import="Scene-Geometry"/>
        </node>

        <node>
            <fbo id="reflection-buffer" draw-buffers="1"/>
            <node>
                <texture name="gDepthTexture" fbo="reflection-buffer" attachment="depth"/>
                <texture name="gDiffuseTexture" fbo="reflection-buffer" attachment="0"/>
                <texture name="gSpecularTexture" fbo="reflection-buffer" attachment="2"/>
                <texture name="gNorWorldTexture" fbo="reflection-buffer" attachment="3"/>
                <node import="Shading-Pass-No-Shadow"/>
            </node>
            <node import="Sky"/>
        </node>

        <node>
            <input type="int" name="numBlurPixels" value="4"/>
            <input type="float" name="blurSigma" value="1.5"/>

            <filter-sequence id="blurred-reflection" fbo="reflection-buffer" attachment="1">
                <filter shader="regen.filter.sampling" scale="0.5"/>
                <filter shader="regen.filter.blur.horizontal"/>
                <filter shader="regen.filter.blur.vertical"/>
            </filter-sequence>
        </node>

        <view id="Reflection">
            <blit src-fbo="reflection-buffer" src-attachment="1" dst-fbo="SCREEN"/>
        </view>
        <view id="Blurred Reflection">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" id="blurred-reflection" />
            <fullscreen-pass shader="regen.filter.sampling"/>
        </view>
    </node>

    <!--**************************-->
    <!--***** Water Rendering ****-->
    <!--**************************-->

    <texture id="water-normal" file="res/textures/water/normal.png" wrapping="REPEAT"/>
    <texture id="water-height" file="res/textures/water/height.jpg" wrapping="REPEAT"/>
    <texture id="water-foam" file="res/textures/water/foam2.jpg" wrapping="REPEAT"
             swizzle-g="RED" swizzle-b="RED"/>

    <!-- water surface mesh used for depth rendering and post-processing effects -->
    <!-- FIXME: this does not work well when camera is facing downwards, effectively looking behind its position in xz plane. -->
    <mesh id="water-mesh" type="rectangle" lod="0" center="1"
          use-normal="0" use-texco="0" use-tangent="0"
          rotation="0.0,0.0,3.1415"
          scaling="{{far-plane}},1.0,{{far-plane}}"
          update-frequency="NEVER">
        <transform update-frequency="NEVER">
            <translate value="0.0,{{water-level}},-{{far-plane*0.5}}"/>
        </transform>
    </mesh>

    <block type="ubo" id="WaterUBO" update-frequency="NEVER">
        <input type="vec4" name="normalModifier" value="1.0,2.0,4.0,8.0"/>
        <input type="vec3" name="waterColor" value="0.0078,0.4,0.55"/>
        <input type="float" name="sunScale" value="1.5"/>
        <input type="vec3" name="deepWaterColor" value="0.0078,0.5176,0.7"/>
        <input type="float" name="shininess" value="0.2"/>
        <input type="vec3" name="colorExtinction" value="7.0,30.0,40.0"/>
        <input type="float" name="fadeSpeed" value="0.1"/>
        <input type="vec3" name="foamExistence" value="0.45,1.35,1.25"/>
        <input type="float" name="foamIntensity" value="0.5"/>
        <input type="vec2" name="windDirection" value="0.9,0.0"/>
        <input type="vec2" name="waveScale" value="0.05,0.05"/>
        <input type="float" name="heightTextureSize" value="256.0"/>
        <input type="float" name="surfaceHeight" value="{{water-level}}"/>
        <input type="float" name="normalScale" value="3.0"/>
        <input type="float" name="refractionConstant" value="30.0"/>
        <input type="float" name="refractionStrength" value="0.24"/>
        <input type="float" name="shoreHardness" value="0.1"/>
        <input type="float" name="maxAmplitude" value="1.5"/>
        <input type="float" name="reflectionDisplace" value="10.0"/>
        <input type="float" name="visibility" value="0.9"/>
        <input type="float" name="foamHardness" value="1.0"/>
    </block>

    <node id="Water-Rendering">
        <depth test="1" write="0"/>
        <define key="IS_VIEW_ALIGNED_GROUND_QUAD" value="TRUE"/>
        <toggle key="CLIP_DISTANCE0" value="1"/>
        <toggle key="CLIP_DISTANCE1" value="1"/>
        <toggle key="CLIP_DISTANCE2" value="1"/>
        <toggle key="CLIP_DISTANCE3" value="1"/>

        <define key="USE_REFRACTION" value="TRUE"/>
        <define key="USE_FOAM" value="FALSE"/>
        <define key="USE_RIPPLES" value="TRUE"/>
        <define key="USE_SPECULAR" value="TRUE"/>

        <input name="WaterUBO" ubo="WaterUBO"/>
        <texture name="depthTexture" fbo="g-buffer" attachment="depth"/>
        <texture name="refractionTexture" fbo="g-buffer" attachment="1"/>
        <texture name="reflectionTexture" id="blurred-reflection"/>
        <texture name="normalTexture" id="water-normal"/>
        <texture name="heightTexture" id="water-height"/>
        <texture name="foamTexture" id="water-foam"/>
        <input type="time" name="time" scale="0.003"/>
        <!-- imported inputs -->
        <input name="ReflectionCamera" state="reflection-camera" component="Camera" member-suffix="_Reflection"/>
        <input name="SunLight" state="sky-sun" component="Light" member-suffix="_Sun"/>

        <mesh id="water-mesh" shader="regen.terrain.water.plane" />
    </node>

    <!-- Render surface plane into depth buffer
         to be used for post-processing effects -->
    <node id="Water-Depth">
        <depth test="1" write="1"/>
        <define key="IS_VIEW_ALIGNED_GROUND_QUAD" value="TRUE"/>
        <define key="OUTPUT_TYPE" value="DEPTH"/>
        <mesh id="water-mesh" shader="regen.models.mesh" />
    </node>

    <!--**************************-->
    <!--********* Animals **********-->
    <!--**************************-->

    <mesh id="fish-mesh" type="asset"
            asset="fish-asset" asset-indices="*" asset-animation="0"
            lod-simplification="0.6, 0.4, 0.2"
            lod-thresholds="6.0, 40.0"
            num-instances="{{num-fish}}"
            update-frequency="NEVER">
        <transform id="fish-tf"
                num-instances="{{num-fish}}" is-instanced="1"
                update-frequency="NEVER">
            <scale value="0.001, 0.001, 0.001"/>
            <translate value="0.0, -5.5, 30.0"/>
            <set mode="circle" target="translate" radius="1.0" variance="0.8"
                dir-x="10.0, 0.0, 0.0" dir-z="0.0, 1.0, 10.0"/>
            <animation type="boids"
                sim-mode="GPU"
                base-orientation="1.570796"
                max-speed="4.0"
                max-neighbors="100"
                visual-range="1.6"
                look-ahead="2.0"
                repulsion="8.0"
                coherence-weight="10.0"
                alignment-weight="10.0"
                avoidance-weight="10.0"
                avoidance-distance="0.5"
                separation-weight="10.0"
                bounds-min="-500.0, {{map-y-min}}, -150.0"
                bounds-max="500.0, {{water-level}}, 150.0"
                map-center="0, {{map-y-min}}, 0"
                map-size="{{map-size}}, {{map-size}}"
                height-map="ground-height"
                height-map-factor="{{map-height}}">
                <home-point value="37.0, -2.0, 6.3" />
                <home-point value="-38.87, -2.0, 2.44" />
                <home-point value="-22.31, -2.0, -2.03" />
                <home-point value="7.35, -2.0, 2.15" />
                <!-- <object type="danger" tf="hyena-tf" /> -->
                <!-- <object type="attractor" tf="hyena-tf" /> -->
            </animation>
        </transform>
        <lod-meshes>
            <mesh id="fish-impostor"
                    type="impostor-billboard"
                    base-mesh="fish-mesh"
                    base-mesh-index="0"
                    depth-offset="0.5"
                    normal-correction="1"
                    depth-correction="0"
                    hemispherical="1"
                    top-view="0"
                    bottom-view="0"
                    longitude-steps="8"
                    latitude-steps="2"
                    texture-size="64,64"
                    update-frequency="NEVER">
                <shader mesh-index="0" key="regen.models.impostor">
                    <alpha discard-threshold="0.5"/>
                </shader>
                <update-state>
                    <depth test="0" write="0"/>
                </update-state>
            </mesh>
        </lod-meshes>
        <shape id="fish-shape" cull="1" gpu="1" type="sphere" mesh-id="fish-mesh" transform-id="fish-tf" />
        <!-- <shape id="fish-shape" index="1" type="obb" mesh-id="fish-mesh" transform-id="fish-tf" /> -->
    </mesh>

    <node id="Fish">
        <node id="fish0">
            <mesh id="fish-mesh" mesh-index="0" shader="regen.models.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--********* Fog **********-->
    <!--**************************-->

    <node id="Fog-Draw">
        <node id="Distance-Fog">
            <fbo id="g-buffer" draw-buffers="1"/>
            <input type="float" name="fogDensity" value="1.0"/>
            <input type="vec2" name="fogDistance" value="50.0,150.0" min="0,0" max="200"/>
            <input type="vec3" name="fogColor" value="0.25, 0.35, 0.3" schema="color"/>
            <!--
            <input type="float" name="fogHeightMax" value="15.0"/>
            <input type="float" name="fogHeightMin" value="-10.0"/>
            -->
            <input type="vec2" name="farDistance" value="150.0,200.0"/>
            <input name="SunLight" state="sky-sun" component="Light" member-suffix="_Sun"/>
            <input type="vec3" name="warmTint" value="0.6, 0.4, 0.3" />
            <texture name="gDepthTexture" fbo="g-buffer" attachment="depth"/>
            <texture name="gColorTexture" fbo="g-buffer" attachment="0"/>
            <texture name="skyColorTexture" id="sky"/>
            <fullscreen-pass shader="regen.weather.fog.distance"/>
        </node>
        <view id="Fog">
            <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
        </view>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="Shadow-Caster">
    </node>

    <node id="Non-Shadow-Caster">
        <node import="Fish"/>
    </node>

    <node id="Scene-Geometry">
        <node import="Ground"/>
        <!--
        <node id="Water-Test">
            <depth test="1" write="1"/>
            <define key="IS_VIEW_ALIGNED_GROUND_QUAD" value="TRUE"/>
            <mesh id="water-mesh" shader="regen.models.mesh" />
        </node>
        -->
    </node>

    <node id="Shading-Pass">
        <depth test="0" write="0"/>
        <input type="vec3" name="lightAmbient" value="0.2,0.2,0.2"/>

        <node id="Light-Shading">
            <node>
                <define key="DEBUG_SHADOW_SLICES" value="0" />
                <light-pass type="DIRECTIONAL" ambient="1"
                    shader="regen.shading.deferred.directional">
                    <light id="sky-sun" />
                </light-pass>
            </node>
        </node>
    </node>

    <node id="Shading-Pass-No-Shadow">
        <depth test="0" write="0"/>
        <input type="vec3" name="lightAmbient" value="0.2,0.2,0.2"/>

        <node id="Light-Shading">
            <node>
                <light-pass type="DIRECTIONAL" ambient="1" shader="regen.shading.deferred.directional">
                    <!-- <light id="sky-sun"/> -->
                    <light id="sky-moon"/>
                </light-pass>
            </node>
        </node>
    </node>

    <!--**************************-->
    <!--** Post shading effects **-->
    <!--**************************-->

    <node id="Post-Pass">
        <depth test="0" write="0"/>

        <!-- Copy G-buffer albedo into the first attachment such that we can run water shader
             only locally where water is visible. -->
        <!-- TODO: The blit below is a bit expensive, and not needed where water is visible!
                   However, the depth pass below cannot be moved before the water rendering,
                   as it needs to sample the depth buffer.
                   It could be that doing a stencil only pass first, then doing
                   a "stencil-blit" would be cheaper... -->
        <node id="Water-Blit-Albedo">
            <blit filter-mode="NEAREST"
                src-fbo="g-buffer" src-attachment="1"
                dst-fbo="g-buffer" dst-attachment="0"/>
        </node>
        <node import="Water-Rendering">
            <fbo id="g-buffer" draw-buffers="0"/>
        </node>
        <!-- Render water surface depth into G-buffer depth. -->
        <!-- Note: Water depth pass is needed for depth-based effects like fog rendering. -->
        <node import="Water-Depth">
            <fbo id="g-buffer" draw-buffers="0"/>
        </node>
        <view id="Water">
            <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
        </view>

        <!-- render transparent objects -->
        <node id="Transparent-Pass">
            <fbo id="g-buffer" draw-buffers="0"/>
            <blend mode="add"/>
            <depth test="1" write="0"/>
            <!-- render emission light -->
            <node id="Material-Emission">
                <texture name="gEmissionTexture" fbo="g-buffer" attachment="4"/>
                <texture name="gEmissionBlurred" id="emission-map-bloom"/>
                <!-- <texture name="gEmissionBlurred" id="emission-map-blur" /> -->
                <fullscreen-pass shader="regen.shading.deferred.emission"/>
            </node>
            <!-- <node import="Fire" /> -->
            <view id="Transparent Objects">
                <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
            </view>
        </node>

        <node import="Fog-Draw"/>
        <node import="Sky"/>
        <node import="Scene-Blur"/>
        <node import="ToneMapping">
            <fbo id="g-buffer" draw-buffers="0"/>
        </node>
        <view id="Scene -- ToneMapping">
            <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
        </view>
    </node>

    <node id="Scene-Blur">
        <input type="int" name="numBlurPixels" value="10"/>
        <input type="float" name="blurSigma" value="2.5"/>

        <filter-sequence id="blurred-scene" fbo="g-buffer" attachment="1">
            <filter shader="regen.filter.sampling" scale="0.5"/>
            <filter shader="regen.filter.blur.horizontal"/>
            <filter shader="regen.filter.blur.vertical"/>
        </filter-sequence>

        <view id="Blurred Scene">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" id="blurred-scene" />
            <fullscreen-pass shader="regen.filter.sampling"/>
        </view>
    </node>

    <block type="ubo" id="ToneMapping" update-frequency="NEVER">
        <input type="float" name="blurAmount" value="0.3"/>
        <input type="float" name="effectAmount" value="0.1"/>
        <input type="float" name="exposure" value="1.7"/>
        <input type="float" name="gamma" value="1.1"/>
        <input type="float" name="radialBlurSamples" value="26.0"/>
        <input type="float" name="radialBlurStartScale" value="1.0"/>
        <input type="float" name="radialBlurScaleMul" value="0.9555"/>
        <input type="float" name="vignetteInner" value="0.9"/>
        <input type="float" name="vignetteOuter" value="1.75"/>
    </block>

    <node id="ToneMapping">
        <define key="USE_RADIAL_BLUR" value="TRUE"/>
        <define key="USE_VIGNETTE" value="TRUE"/>
        <texture name="inputTexture" fbo="g-buffer" attachment="1"/>
        <texture name="blurTexture" id="blurred-scene"/>
        <input name="ToneMapping" ubo="ToneMapping"/>
        <fullscreen-pass shader="regen.filter.tonemap"/>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="root">
        <resource id="sky" />
        <input name="Scene" ubo="SceneUBO"/>

        <node id="Pre-Render">
            <node import="Reflection-Pass"/>
        </node>

        <node id="Debugging">
            <node import="overview-node"/>
        </node>

        <node id="Render">
            <fbo id="g-buffer" clear-buffers="0,1,2,3,4" clear-depth="1"/>
            <camera id="main-camera" />

            <node id="Geometry-Pass">
                <fbo id="g-buffer" draw-buffers="0,1,2,3,4"/>
                <depth test="1" write="1"/>
                <node import="Shadow-Caster"/>
                <node import="Non-Shadow-Caster"/>
                <node import="Scene-Geometry"/>
                <node import="G-Buffer-Views"/>
                <view id="G-Buffer: Emission">
                    <blit src-fbo="g-buffer" src-attachment="4" dst-fbo="SCREEN"/>
                </view>
            </node>

            <node id="Post-Geometry">
                <node id="Emission-Update">
                    <input type="float" name="filterRadius" value="0.01"/>
                    <bloom fbo="g-buffer" attachment="4" bloom-texture="emission-map-bloom"/>
                </node>
                <view id="Emission Mips">
                    <fbo id="SCREEN"/>
                    <texture name="inputTexture1" id="emission-map-bloom" mip-level="0"/>
                    <texture name="inputTexture2" id="emission-map-bloom" mip-level="1"/>
                    <texture name="inputTexture3" id="emission-map-bloom" mip-level="2"/>
                    <texture name="inputTexture4" id="emission-map-bloom" mip-level="3"/>
                    <fullscreen-pass shader="regen.filter.sampling.x4"/>
                </view>
            </node>

            <node id="Shading">
                <fbo id="g-buffer" draw-buffers="1"/>
                <node id="Light-Pass">
                    <texture name="gDepthTexture" fbo="g-buffer" attachment="depth"/>
                    <texture name="gDiffuseTexture" fbo="g-buffer" attachment="0"/>
                    <texture name="gSpecularTexture" fbo="g-buffer" attachment="2"/>
                    <texture name="gNorWorldTexture" fbo="g-buffer" attachment="3"/>
                    <node import="Shading-Pass"/>
                </node>
                <view id="Shaded Scene">
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </view>
            </node>

            <node import="Post-Pass"/>

            <view id="Spatial Index">
                <node import="spatial-index-debug">
                    <camera id="main-camera"/>
                    <fbo id="g-buffer" draw-buffers="0"/>
                </node>
                <node>
                    <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
                </node>
            </view>

            <node import="GUI-Pass">
                <fbo id="g-buffer" draw-buffers="0"/>
            </node>

            <view id="Scene -- Result">
                <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
            </view>
        </node>
    </node>
</node>
