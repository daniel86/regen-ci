<?xml version="1.0" encoding="UTF-8" ?>

<node>
    <constant name="map-size" value="1000.0"/>
    <constant name="map-height" value="24.0"/>
    <constant name="map-y-min" value="-12.0"/>
    <constant name="map-frame-height" value="18.0"/>
    <constant name="map-frame-offset" value="-6.0"/>
    <constant name="map-frame-size" value="999.5"/>
    <constant name="water-surface-y" value="1.7"/>
    <constant name="num-fish" value="100000"/>

    <include xml-file="scene-display/examples/templates/default.xml"/>
    <node id="configuration"
            date="01-09-2014 06:00:00"
            time-scale="60.0">
        <camera id="main-camera"
                mode="first-person"
                speed="0.05"
                eye-offset="0.0,0.0,0.0"
                horizontal-orientation="4.71225"
                vertical-orientation="0.25"
                ease-in-out="1.8"
                anchor-pause-time="0.7"
                anchor-time-scale="0.8">
        </camera>
    </node>

    <!-- FBO for deferred shading -->
    <fbo id="g-buffer"
         size-mode="rel" size="1.0,1.0"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="ambient"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <texture id="emission" pixel-components="3"/>
        <depth pixel-size="24"/>
    </fbo>
    <fbo id="reflection-buffer"
         size="512, 512"
         pixel-type="UNSIGNED_BYTE"
         pixel-size="16"
         pixel-components="4">
        <texture id="diffuse"/>
        <texture id="ambient"/>
        <texture id="specular"/>
        <texture id="normal"/>
        <depth id="depth" pixel-size="24"/>
    </fbo>
    <!-- Textures -->
    <texture id="emission-map-bloom" type="bloom" num-mips="4" input-fbo="g-buffer"/>
    <texture id="ground-color" file="res/textures/terrain/canyon/diffuse.png"/>
    <texture id="ground-normal" file="res/textures/terrain/canyon/normal.png"/>
    <texture id="ground-height" file="res/textures/terrain/canyon/height.png"/>
    <texture id="grass-mask" file="res/textures/terrain/canyon/mask-grass.png"/>
    <texture id="grass-color" file="res/textures/materials/grass/0/color.png" wrapping="CLAMP_TO_EDGE" />
    <texture id="wind-flowmap" file="res/textures/wind/flowmap0.png" wrapping="REPEAT"/>
    <texture id="wind-noise" type="noise" preset="cloud"
            size="128.0,128.0,1.0" swizzle-g="RED" swizzle-b="RED"/>
    <!-- Spatial Index -->
    <index id="main-index" type="quadtree" max-objects-per-node="4"/>
    <!-- Cameras -->
    <camera id="main-camera"
            culling-index="main-index"
            fov="45.0" near="0.1" far="200.0"
            position="-40.0, 14.0, 0.0"/>
    <camera id="reflection-camera"
            culling-index="main-index"
            camera="main-camera"
            reflector-normal="0,1,0"
            reflector-point="0,{{water-surface-y}},0"/>
    <!-- Assets -->
    <asset id="fish-asset" type="asset"
           file="res/models/fish-puffer/PufferFish.fbx"
           ignore-normal-map="1">
    </asset>
    <!-- UBOs -->
    <block type="ubo" id="SceneUBO">
        <uniform name="planeSize" type="vec2" value="{{map-size}}, {{map-size}}"/>
        <uniform name="wind" type="vec2" value="0.6, 0.6"/>
        <uniform name="windFlowScale" type="float" value="50.0"/>
        <uniform name="windFlowTime" type="float" value="0.1"/>
        <uniform name="windStrength" type="float" value="1.0"/>
    </block>
    <!-- Sky -->
    <sky id="sky" camera="main-camera" update-interval="200.0" >
        <star-map texture="res/sky/milkyway.png" scattering="0.8" delta-magnitude="0.5" lod="0" />
        <stars catalog="res/sky/bright-stars.bin" scale="1.4"
            scattering="1.0" scintillation="0.2" apparent-magnitude="6.0"
            glare-intensity="0.04" glare-scale="0.2"
            color="0.66,0.78,1.0" color-ratio="0.66"/>
        <moon texture="res/sky/moon.png" scale="0.04" scattering="4.0"
            sun-shine-color="0.923,0.786,0.636" sun-shine-intensity="128.0"
            earth-shine-color="0.88,0.96,1.0" earth-shine-intensity="8.0" />
        <atmosphere preset="earth" size="256" lod="0">
            <input type="float" name="cirrus" value="0.8" />
            <input type="float" name="cumulus" value="0.6" />
            <input type="float" name="dithering" value="0.2" />
            <input type="float" name="ditheringScale" value="100.0" />
            <input type="float" name="cloudTimeFactor" value="0.3" />
        </atmosphere>
    </sky>

    <!--**************************-->
    <!--****** Ground mesh *******-->
    <!--**************************-->

    <mesh id="ground-mesh"
          type="ground"
          lod-levels="6,5,4,2"
          lod-thresholds="40.0, 80.0, 120.0"
          patch-density="35"
          map-size="{{map-size}},{{map-height}},{{map-size}}"
          map-center="0.0,0.0,0.0"
          skirt-size="1.4"
          weight-map-size="2024"
          weight-mips="1"
          height-map="ground-height"
          normal-map="ground-normal"
          tf="ground-tf">
        <transform id="ground-tf" />
        <materials>
            <material type="grass" name="ground/grass" variant="1" uv-scale="0.25"
                    height-range="0.25, 0.75" height-smooth="0.25"
                    slope-range="0.0, 25.0" slope-smooth="10.0"/>
            <material type="rock" name="ground/stone" variant="8" uv-scale="0.1"
                    height-range="0.0, 1.0"
                    slope-range="30.0, 180.0" slope-smooth="30.0"/>
            <material type="sand" name="ground/sand" variant="3" uv-scale="0.05"
                    height-range="0.0, 0.3" height-smooth="0.2"
                    slope-range="0.0, 15.0" slope-smooth="15.0"/>
            <material type="dirt" name="ground/dirt" variant="1" uv-scale="0.5" is-fallback="1"
                    height-range="0.0, 0.75" height-smooth="0.2"
                    slope-range="10.0, 180.0" slope-smooth="20.0"/>
        </materials>
        <shape id="ground-shape" index="1" cull="1" type="obb"
            mesh-id="ground-mesh" transform-id="ground-tf" />
    </mesh>

    <mesh id="ground-frame"
          type="frame"
          lod="0"
          scaling="{{map-frame-size}},{{map-frame-height}},{{map-frame-size}}"
          border-size="0.05"
          use-normal="0"
          use-tangent="0"
          usage="STATIC_DRAW">
        <transform>
            <translate value="0.0, {{map-frame-offset}}, 0.0"/>
        </transform>
        <material preset="stone"/>
    </mesh>

    <node id="Ground">
        <node id="Ground-quad">
            <!--
            <input type="float" name="noiseScale" value="0.005"/>
            <texture name="noiseTexture" id="ground-noise"/>
            -->
            <mesh id="ground-mesh" shader="regen.terrain.ground"/>
        </node>
        <!-- we add a frame around the ground mesh to avoid problems at the edges
             with how distance fog is calculated based on depth (it may not correctly
             handle water at the boundaries where there is nothing behind the water) -->
        <node id="Ground-frame">
            <mesh id="ground-frame" shader="regen.models.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--**** Water Reflection ****-->
    <!--**************************-->

    <node id="Reflection-Pass">
        <!-- need to load the resource before the reflection pass -->
        <camera id="reflection-camera"/>
        <fbo id="reflection-buffer" clear-buffers="0,1,2,3" clear-depth="1"/>

        <node>
            <blend mode="src"/>
            <depth test="1" write="1"/>
            <fbo id="reflection-buffer" draw-buffers="0,1,2,3"/>

            <node import="Shadow-Caster"/>
            <node import="Scene-Geometry"/>
        </node>

        <node>
            <fbo id="reflection-buffer" draw-buffers="1"/>
            <node>
                <texture name="gDepthTexture" fbo="reflection-buffer" attachment="depth"/>
                <texture name="gDiffuseTexture" fbo="reflection-buffer" attachment="0"/>
                <texture name="gSpecularTexture" fbo="reflection-buffer" attachment="2"/>
                <texture name="gNorWorldTexture" fbo="reflection-buffer" attachment="3"/>
                <node import="Shading-Pass-No-Shadow"/>
            </node>
            <node import="Background-Objects"/>
        </node>

        <node>
            <input type="int" name="numBlurPixels" value="4"/>
            <input type="float" name="blurSigma" value="1.5"/>

            <filter-sequence id="blurred-reflection" fbo="reflection-buffer" attachment="1">
                <filter shader="regen.filter.sampling" scale="0.5"/>
                <filter shader="regen.filter.blur.horizontal"/>
                <filter shader="regen.filter.blur.vertical"/>
            </filter-sequence>
        </node>

        <view id="Reflection">
            <blit src-fbo="reflection-buffer" src-attachment="1" dst-fbo="SCREEN"/>
        </view>
        <view id="Blurred Reflection">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" id="blurred-reflection" />
            <fullscreen-pass shader="regen.filter.sampling"/>
        </view>
    </node>

    <!--**************************-->
    <!--***** Water Rendering ****-->
    <!--**************************-->

    <texture id="water-normal" file="res/textures/water/normal.png" wrapping="REPEAT"/>
    <texture id="water-height" file="res/textures/water/height.jpg" wrapping="REPEAT"/>
    <texture id="water-foam" file="res/textures/water/foam2.jpg" wrapping="REPEAT"
             swizzle-g="RED" swizzle-b="RED"/>

    <block type="ubo" id="WaterUBO">
        <input type="vec4" name="normalModifier" value="1.0,2.0,4.0,8.0"/>
        <input type="vec3" name="waterColor" value="0.0078,0.4,0.55"/>
        <input type="float" name="sunScale" value="1.5"/>
        <input type="vec3" name="deepWaterColor" value="0.0078,0.5176,0.7"/>
        <input type="float" name="shininess" value="0.2"/>
        <input type="vec3" name="colorExtinction" value="7.0,30.0,40.0"/>
        <input type="float" name="fadeSpeed" value="0.1"/>
        <input type="vec3" name="foamExistence" value="0.45,1.35,1.25"/>
        <input type="float" name="foamIntensity" value="0.5"/>
        <input type="vec2" name="windDirection" value="0.9,0.0"/>
        <input type="vec2" name="waveScale" value="0.05,0.05"/>
        <input type="float" name="heightTextureSize" value="256.0"/>
        <input type="float" name="surfaceHeight" value="{{water-surface-y}}"/>
        <input type="float" name="normalScale" value="3.0"/>
        <input type="float" name="refractionConstant" value="30.0"/>
        <input type="float" name="refractionStrength" value="0.24"/>
        <input type="float" name="shoreHardness" value="0.1"/>
        <input type="float" name="maxAmplitude" value="1.5"/>
        <input type="float" name="reflectionDisplace" value="10.0"/>
        <input type="float" name="visibility" value="0.9"/>
        <input type="float" name="foamHardness" value="1.0"/>
    </block>

    <node id="Water-Rendering">
        <depth test="0" write="0"/>
        <blend mode="src"/>

        <define key="USE_REFRACTION" value="TRUE"/>
        <define key="USE_FOAM" value="FALSE"/>
        <define key="USE_RIPPLES" value="TRUE"/>
        <define key="USE_SPECULAR" value="TRUE"/>

        <input name="WaterUBO" ubo="WaterUBO"/>
        <texture name="depthTexture" fbo="g-buffer" attachment="depth"/>
        <texture name="refractionTexture" fbo="g-buffer" attachment="1"/>
        <texture name="reflectionTexture" id="blurred-reflection"/>
        <texture name="normalTexture" id="water-normal"/>
        <texture name="heightTexture" id="water-height"/>
        <texture name="foamTexture" id="water-foam"/>
        <input type="time" name="time" scale="0.003"/>
        <!-- imported inputs -->
        <input name="reflectionMatrix" state="reflection-camera" component="viewProjectionMatrix"/>
        <input name="sunDirection" state="sky-sun" component="lightDirection"/>
        <input name="sunColor" state="sky-sun" component="lightDiffuse"/>

        <fullscreen-pass shader="regen.terrain.water"/>
    </node>

    <!--**************************-->
    <!--********* Animals **********-->
    <!--**************************-->

    <mesh id="fish-mesh" type="asset"
            asset="fish-asset" asset-indices="*" asset-animation="0"
            lod-simplification="0.6, 0.4, 0.2"
            lod-thresholds="6.0, 40.0"
            num-instances="{{num-fish}}">
        <transform id="fish-tf" num-instances="{{num-fish}}" is-instanced="1">
            <scale value="0.001, 0.001, 0.001"/>
            <translate value="0.0, -5.5, 30.0"/>
            <set mode="circle" target="translate" radius="1.0" variance="0.8"
                dir-x="10.0, 0.0, 0.0" dir-z="0.0, 1.0, 10.0"/>
            <animation type="boids"
                sim-mode="GPU"
                base-orientation="1.570796"
                max-speed="4.0"
                max-neighbors="100"
                visual-range="1.6"
                look-ahead="2.0"
                repulsion="8.0"
                coherence-weight="10.0"
                alignment-weight="10.0"
                avoidance-weight="10.0"
                avoidance-distance="0.5"
                separation-weight="10.0"
                bounds-min="-500.0, {{map-y-min}}, -150.0"
                bounds-max="500.0, {{water-surface-y}}, 150.0"
                map-center="0, {{map-y-min}}, 0"
                map-size="{{map-size}}, {{map-size}}"
                height-map="ground-height"
                height-map-factor="{{map-height}}">
                <home-point value="37.0, -2.0, 6.3" />
                <home-point value="-38.87, -2.0, 2.44" />
                <home-point value="-22.31, -2.0, -2.03" />
                <home-point value="7.35, -2.0, 2.15" />
                <!-- <object type="danger" tf="hyena-tf" /> -->
                <!-- <object type="attractor" tf="hyena-tf" /> -->
            </animation>
        </transform>
        <shape id="fish-shape" gpu="1" cull="1" type="sphere" mesh-id="fish-mesh" transform-id="fish-tf" />
        <!-- <shape id="fish-shape" index="1" type="obb" mesh-id="fish-mesh" transform-id="fish-tf" /> -->
    </mesh>

    <node id="Fish">
        <node id="fish0">
            <mesh id="fish-mesh" mesh-index="0" shader="regen.models.mesh"/>
        </node>
    </node>

    <!--**************************-->
    <!--********* Fog **********-->
    <!--**************************-->

    <node id="Fog-Draw">
        <node id="Distance-Fog">
            <blend mode="alpha"/>
            <input type="float" name="fogDensity" value="1.0"/>
            <input type="vec2" name="fogDistance" value="100.0,200.0"/>
            <input type="vec3" name="fogColor" value="0.35, 0.55, 0.5"/>
            <input type="vec3" name="sunPosition" state="sky-sun" component="lightPosition"/>
            <texture name="gDepthTexture" fbo="g-buffer" attachment="depth"/>
            <texture name="skyColorTexture" id="sky"/>
            <fullscreen-pass shader="regen.weather.fog.distance"/>
        </node>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="Shadow-Caster">
    </node>

    <node id="Non-Shadow-Caster">
        <node import="Fish"/>
    </node>

    <node id="Scene-Geometry">
        <node import="Ground"/>
    </node>

    <node id="Background-Objects">
        <node id="Sky">
            <sky id="sky"/>
        </node>
    </node>

    <node id="Shading-Pass">
        <blend mode="add"/>
        <depth test="0" write="0"/>
        <input type="vec3" name="lightAmbient" value="0.2,0.2,0.2"/>

        <node id="Ambient-Shading">
            <fullscreen-pass shader="regen.shading.deferred.ambient"/>
        </node>
        <node id="Light-Shading">
            <define key="DEBUG_SHADOW_SLICES" value="0" />
            <node>
                <light-pass type="DIRECTIONAL"
                    shader="regen.shading.deferred.directional">
                    <light id="sky-sun" />
                </light-pass>
            </node>
        </node>
    </node>

    <node id="Shading-Pass-No-Shadow">
        <blend mode="add"/>
        <depth test="0" write="0"/>
        <input type="vec3" name="lightAmbient" value="0.2,0.2,0.2"/>

        <node id="Ambient-Shading">
            <fullscreen-pass shader="regen.shading.deferred.ambient"/>
        </node>
        <node id="Light-Shading">
            <node>
                <light-pass type="DIRECTIONAL" shader="regen.shading.deferred.directional">
                    <!-- <light id="sky-sun"/> -->
                    <light id="sky-moon"/>
                </light-pass>
            </node>
        </node>
    </node>

    <!--**************************-->
    <!--** Post shading effects **-->
    <!--**************************-->

    <node id="Post-Pass">
        <depth test="0" write="0"/>
        <node import="Water-Rendering">
            <fbo id="g-buffer" draw-buffers="0"/>
        </node>

        <!-- render transparent objects -->
        <node id="Transparent-Pass">
            <fbo id="g-buffer" draw-buffers="0"/>
            <blend mode="add"/>
            <depth test="1" write="0"/>
            <!-- render emission light -->
            <node id="Material-Emission">
                <texture name="gEmissionTexture" fbo="g-buffer" attachment="4"/>
                <texture name="gEmissionBlurred" id="emission-map-bloom"/>
                <!-- <texture name="gEmissionBlurred" id="emission-map-blur" /> -->
                <fullscreen-pass shader="regen.shading.deferred.emission"/>
            </node>
            <!-- <node import="Fire" /> -->
            <view id="Transparent Objects">
                <blit src-fbo="g-buffer" src-attachment="0" dst-fbo="SCREEN"/>
            </view>
        </node>

        <node import="Fog-Draw"/>
        <node import="Scene-Blur"/>
        <node import="ToneMapping">
            <fbo id="g-buffer" draw-buffers="1"/>
        </node>
        <view id="Scene -- ToneMapping">
            <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
        </view>
    </node>

    <node id="Scene-Blur">
        <input type="int" name="numBlurPixels" value="10"/>
        <input type="float" name="blurSigma" value="2.5"/>

        <filter-sequence id="blurred-scene" fbo="g-buffer" attachment="0">
            <filter shader="regen.filter.sampling" scale="0.5"/>
            <filter shader="regen.filter.blur.horizontal"/>
            <filter shader="regen.filter.blur.vertical"/>
        </filter-sequence>

        <view id="Blurred Scene">
            <fbo id="SCREEN"/>
            <texture name="inputTexture" id="blurred-scene" />
            <fullscreen-pass shader="regen.filter.sampling"/>
        </view>
    </node>

    <block type="ubo" id="ToneMapping">
        <input type="float" name="blurAmount" value="0.3"/>
        <input type="float" name="effectAmount" value="0.1"/>
        <input type="float" name="exposure" value="1.7"/>
        <input type="float" name="gamma" value="1.1"/>
        <input type="float" name="radialBlurSamples" value="26.0"/>
        <input type="float" name="radialBlurStartScale" value="1.0"/>
        <input type="float" name="radialBlurScaleMul" value="0.9555"/>
        <input type="float" name="vignetteInner" value="0.9"/>
        <input type="float" name="vignetteOuter" value="1.75"/>
    </block>

    <node id="ToneMapping">
        <define key="USE_RADIAL_BLUR" value="TRUE"/>
        <define key="USE_VIGNETTE" value="TRUE"/>
        <texture name="inputTexture" fbo="g-buffer" attachment="0"/>
        <texture name="blurTexture" id="blurred-scene"/>
        <input name="ToneMapping" ubo="ToneMapping"/>
        <fullscreen-pass shader="regen.filter.tonemap"/>
    </node>

    <!--**************************-->
    <!--**************************-->

    <node id="root">
        <resource id="sky" />
        <input name="Scene" ubo="SceneUBO"/>

        <node id="Pre-Render">
            <node import="Reflection-Pass"/>
        </node>

        <node id="Debugging">
            <node import="overview-node"/>
        </node>

        <node id="Render">
            <fbo id="g-buffer" clear-buffers="0,1,2,3,4" clear-depth="1"/>
            <camera id="main-camera" />

            <node id="Geometry-Pass">
                <fbo id="g-buffer" draw-buffers="0,1,2,3,4"/>
                <blend mode="src"/>
                <depth test="1" write="1"/>
                <node import="Shadow-Caster"/>
                <node import="Non-Shadow-Caster"/>
                <node import="Scene-Geometry"/>
                <node import="G-Buffer-Views"/>
                <view id="G-Buffer: Emission">
                    <blit src-fbo="g-buffer" src-attachment="4" dst-fbo="SCREEN"/>
                </view>
            </node>

            <node id="Post-Geometry">
                <node id="Emission-Update">
                    <input type="float" name="filterRadius" value="0.01"/>
                    <bloom fbo="g-buffer" attachment="4" bloom-texture="emission-map-bloom"/>
                </node>
                <view id="Emission Mips">
                    <fbo id="SCREEN"/>
                    <texture name="inputTexture1" id="emission-map-bloom" mip-level="0"/>
                    <texture name="inputTexture2" id="emission-map-bloom" mip-level="1"/>
                    <texture name="inputTexture3" id="emission-map-bloom" mip-level="2"/>
                    <texture name="inputTexture4" id="emission-map-bloom" mip-level="3"/>
                    <fullscreen-pass shader="regen.filter.sampling.x4"/>
                </view>
            </node>

            <node id="Shading">
                <fbo id="g-buffer" draw-buffers="1"/>
                <node id="Light-Pass">
                    <texture name="gDepthTexture" fbo="g-buffer" attachment="depth"/>
                    <texture name="gDiffuseTexture" fbo="g-buffer" attachment="0"/>
                    <texture name="gSpecularTexture" fbo="g-buffer" attachment="2"/>
                    <texture name="gNorWorldTexture" fbo="g-buffer" attachment="3"/>
                    <node import="Shading-Pass"/>
                </node>
                <view id="Shaded Scene">
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </view>
            </node>

            <node id="Post-Shading">
                <node import="Background-Objects"/>
                <view id="Scene with Background">
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </view>
                <node import="Post-Pass"/>
            </node>

            <view id="Spatial Index">
                <node import="spatial-index-debug">
                    <camera id="main-camera"/>
                    <fbo id="g-buffer" draw-buffers="1"/>
                </node>
                <node>
                    <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
                </node>
            </view>

            <node import="GUI-Pass">
                <fbo id="g-buffer" draw-buffers="1"/>
            </node>

            <view id="Scene -- Result">
                <blit src-fbo="g-buffer" src-attachment="1" dst-fbo="SCREEN"/>
            </view>
        </node>
    </node>
</node>
